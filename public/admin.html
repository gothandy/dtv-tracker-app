<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - DTV Tracker</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .container { max-width: 900px; margin: 1.5rem auto; padding: 0 1.5rem; }
        .admin-section { background: var(--surface); border-radius: var(--radius); padding: 1.5rem; box-shadow: var(--shadow); margin-bottom: 1.5rem; }
        .admin-section h2 { color: var(--dark); font-size: 1.2rem; margin-bottom: 0.75rem; }
        .admin-section h2 a { color: var(--green); text-decoration: none; }
        .admin-section h2 a:hover { text-decoration: underline; }
        .admin-actions { display: flex; flex-wrap: wrap; gap: 0.75rem; }
        .admin-btn {
            display: inline-flex; align-items: center; gap: 0.5rem;
            padding: 0.7rem 1.2rem; border-radius: var(--radius);
            font-size: 0.95rem; font-weight: 600; cursor: pointer;
            border: 2px solid var(--green); background: var(--surface); color: var(--green);
            min-height: 44px; transition: all 0.2s; text-decoration: none;
        }
        .admin-btn:hover { background: var(--green); color: white; }
        .admin-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .sync-result { margin-top: 0.75rem; font-size: 0.9rem; color: var(--text-mid); min-height: 1.2rem; }
        .sync-result.error { color: var(--error); }
        .legend-list { display: flex; flex-wrap: wrap; gap: 0.75rem 1.5rem; }
        .legend-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.95rem; color: var(--text-mid); }
        .legend-item img { width: 20px; height: 20px; }
        .unmatched-list { margin-top: 0.75rem; font-size: 0.9rem; }
        .unmatched-item { display: flex; gap: 1rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
        .unmatched-item .event-id { color: var(--text-light); font-family: monospace; font-size: 0.85rem; }
    </style>
    <script src="/js/common.js"></script>
    <script src="/js/tag-icons.js"></script>
</head>
<body>
    <script>createHeader('Admin', true);</script>

    <div class="container">
        <div class="admin-section admin-only">
            <h2><a href="https://dtv.eventbrite.co.uk/" target="_blank">Eventbrite</a></h2>
            <div class="admin-actions">
                <button class="admin-btn" id="runAllBtn" onclick="runAll()">Run All</button>
                <button class="admin-btn" id="syncSessionsBtn" onclick="syncSessions()">Refresh Events</button>
                <button class="admin-btn" id="syncAttendeesBtn" onclick="syncAttendees()">Fetch New Attendees</button>
                <button class="admin-btn" id="unmatchedBtn" onclick="showUnmatched()">Unmatched Events</button>
                <button class="admin-btn" id="checkConfigBtn" onclick="checkEventConfig()">Check Config</button>
            </div>
            <div class="sync-result" id="syncSessionsResult"></div>
            <div class="sync-result" id="syncAttendeesResult"></div>
            <div id="unmatchedList"></div>
            <div id="configCheckResult"></div>
        </div>

        <div class="admin-section admin-only">
            <h2>Exports</h2>
            <div class="admin-actions">
                <a class="admin-btn" href="/api/sessions/export">FE Hours Download</a>
                <a class="admin-btn" href="/api/records/export">Records Download</a>
            </div>
        </div>

        <div class="admin-section admin-only" id="siteSection" style="display:none;">
            <h2><a id="siteLink" href="#" target="_blank" id="siteName">Site</a></h2>
        </div>

        <div class="admin-section">
            <h2>Icon Legend</h2>
            <div class="legend-list" id="iconLegend"></div>
        </div>
    </div>

    <script>createFooter();</script>
    <script>
        async function runAll() {
            const btn = document.getElementById('runAllBtn');
            btn.disabled = true;
            btn.textContent = 'Running...';
            try {
                await syncSessions();
                await syncAttendees();
                await showUnmatched();
            } finally {
                btn.disabled = false;
                btn.textContent = 'Run All';
            }
        }

        async function syncSessions() {
            const btn = document.getElementById('syncSessionsBtn');
            const result = document.getElementById('syncSessionsResult');
            btn.disabled = true;
            btn.textContent = 'Syncing...';
            result.textContent = '';
            result.className = 'sync-result';

            try {
                const res = await apiFetch('/api/eventbrite/sync-sessions', { method: 'POST' });
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.error || 'Sync failed');

                const d = data.data;
                result.textContent = `${d.totalEvents} events, ${d.matchedEvents} matched, ${d.newSessions} new sessions`;
            } catch (error) {
                result.textContent = error.message || 'Sync failed';
                result.className = 'sync-result error';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Refresh Events';
            }
        }

        async function syncAttendees() {
            const btn = document.getElementById('syncAttendeesBtn');
            const result = document.getElementById('syncAttendeesResult');
            btn.disabled = true;
            btn.textContent = 'Syncing...';
            result.textContent = '';
            result.className = 'sync-result';

            try {
                const res = await apiFetch('/api/eventbrite/sync-attendees', { method: 'POST' });
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.error || 'Sync failed');

                const d = data.data;
                let msg = `${d.sessionsProcessed} sessions, ${d.newProfiles} new profiles, ${d.newEntries} new entries`;
                if (d.newRecords) msg += `, ${d.newRecords} consent records`;
                result.textContent = msg;
            } catch (error) {
                result.textContent = error.message || 'Sync failed';
                result.className = 'sync-result error';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Fetch New Attendees';
            }
        }

        async function showUnmatched() {
            const btn = document.getElementById('unmatchedBtn');
            const list = document.getElementById('unmatchedList');
            btn.disabled = true;
            btn.textContent = 'Loading...';
            list.innerHTML = '';

            try {
                const res = await apiFetch('/api/eventbrite/unmatched-events');
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.error || 'Failed to fetch');

                if (data.data.length === 0) {
                    list.innerHTML = '<div class="sync-result">No unmatched events</div>';
                } else {
                    list.innerHTML = '<div class="unmatched-list">' +
                        data.data.map(e =>
                            `<div class="unmatched-item"><span>${escapeHtml(e.date)}</span><span>${escapeHtml(e.name)}</span><span class="event-id">${escapeHtml(e.eventId)}</span></div>`
                        ).join('') + '</div>';
                }
            } catch (error) {
                list.innerHTML = `<div class="sync-result error">${escapeHtml(error.message || 'Failed to fetch')}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Unmatched Events';
            }
        }

        async function loadSiteLink() {
            try {
                const res = await apiFetch('/api/config');
                const data = await res.json();
                if (data.success && data.data.sharepointSiteUrl) {
                    const url = data.data.sharepointSiteUrl;
                    const isTracker = url.includes('/tracker');
                    document.getElementById('siteLink').href = url;
                    document.getElementById('siteLink').textContent = isTracker ? 'Tracker Site' : 'Members Site';
                    document.getElementById('siteSection').style.display = '';
                }
            } catch (e) { /* ignore */ }
        }

        async function checkEventConfig() {
            const btn = document.getElementById('checkConfigBtn');
            const result = document.getElementById('configCheckResult');
            btn.disabled = true;
            btn.textContent = 'Checking...';
            result.innerHTML = '';

            try {
                const res = await apiFetch('/api/eventbrite/event-config-check');
                const data = await res.json();
                if (!res.ok || !data.success) throw new Error(data.error || 'Check failed');

                if (data.data.length === 0) {
                    result.innerHTML = '<div class="sync-result">No matched live events found</div>';
                    return;
                }

                const rows = data.data.map(e => {
                    const checks = [
                        { label: 'Per Attendee', ok: e.consentQuestionsPerAttendee },
                        { label: 'Child Ticket', ok: e.hasChildTicket },
                        { label: 'Privacy Q', ok: e.hasPrivacyConsentQuestion },
                        { label: 'Photo Q', ok: e.hasPhotoConsentQuestion }
                    ];
                    const badges = checks.map(c =>
                        `<span style="color:${c.ok ? 'var(--green)' : 'var(--error)'}; margin-right:0.5rem">${c.ok ? '✓' : '✗'} ${escapeHtml(c.label)}</span>`
                    ).join('');
                    return `<div class="unmatched-item"><span>${escapeHtml(e.eventName)}</span><span>${badges}</span></div>`;
                });

                result.innerHTML = '<div class="unmatched-list">' + rows.join('') + '</div>';
            } catch (error) {
                result.innerHTML = `<div class="sync-result error">${escapeHtml(error.message || 'Check failed')}</div>`;
            } finally {
                btn.disabled = false;
                btn.textContent = 'Check Config';
            }
        }

        loadSiteLink();

        document.getElementById('iconLegend').innerHTML = TAG_ICONS.map(t =>
            `<div class="legend-item${t.color ? ' icon-' + t.color : ''}">${tagIconImg(t)}<span>${escapeHtml(t.alt)}</span></div>`
        ).join('');
    </script>
</body>
</html>
