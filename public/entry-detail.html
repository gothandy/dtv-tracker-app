<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entry - DTV Tracker</title>
    <link rel="icon" href="/img/favicon.svg" type="image/svg+xml">
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .entry-header { background: var(--surface); border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
        .entry-header h1 { color: var(--dark); font-size: 2rem; margin-bottom: 0.5rem; line-height: 1.3; }
        .entry-header .subtitle { color: var(--text-light); font-size: 1rem; margin-bottom: 1.5rem; }

        .nav-buttons { display: flex; gap: 0.75rem; flex-wrap: wrap; }
        .nav-btn {
            display: inline-flex; align-items: center; gap: 0.4rem;
            padding: 0.6rem 1.1rem; border-radius: var(--radius);
            background: var(--green-bg); color: var(--green); font-weight: 600;
            text-decoration: none; font-size: 0.95rem;
            transition: background 0.2s;
        }
        .nav-btn:hover { background: var(--green-tint); }

        .edit-form { display: flex; flex-direction: column; gap: 1rem; }

        .form-field {
            display: flex; align-items: center; gap: 1rem;
            padding: 1rem 1.25rem; background: var(--surface); border-radius: var(--radius);
            box-shadow: var(--shadow); transition: box-shadow 0.3s;
        }
        .form-field.save-ok { box-shadow: 0 0 0 2px var(--green); }
        .form-field.save-err { box-shadow: 0 0 0 2px var(--error, #e74c3c); }

        .form-label { font-size: 0.85rem; color: var(--text-light); min-width: 80px; flex-shrink: 0; }

        .form-field input[type="number"] {
            font-size: 1.1rem; font-weight: 600; color: var(--text);
            border: 1px solid var(--border); border-radius: 6px;
            padding: 0.5rem 0.75rem; width: 100px; background: var(--surface);
        }
        .form-field input[type="number"]:focus { outline: none; border-color: var(--green); }

        .form-field input[type="checkbox"] {
            width: 22px; height: 22px; accent-color: var(--green); cursor: pointer;
        }

        .form-field textarea {
            flex: 1; font-size: 1rem; color: var(--text); font-family: inherit;
            border: 1px solid var(--border); border-radius: 6px;
            padding: 0.5rem 0.75rem; min-height: 80px; resize: vertical;
            background: var(--surface);
        }
        .form-field textarea:focus { outline: none; border-color: var(--green); }

        .tag-buttons { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 0.5rem; }
        .tag-btn {
            font-size: 1.3rem; padding: 0.3rem 0.5rem; border: 2px solid var(--border);
            border-radius: 6px; background: var(--surface); cursor: pointer;
            transition: all 0.2s; line-height: 1;
        }
        .tag-btn.active { border-color: var(--green); background: var(--green-light); }
        .tag-btn img { width: 22px; height: 22px; vertical-align: middle; }

        @media (max-width: 600px) {
            .entry-header { padding: 1.5rem; }
            .entry-header h1 { font-size: 1.75rem; }
            .nav-buttons { flex-direction: column; }
            .nav-btn { justify-content: center; }
            .form-field { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .form-field input[type="number"] { width: 100%; }
        }
    </style>
    <script src="/js/common.js"></script>
    <script src="/js/tag-icons.js"></script>
</head>
<body class="detail-page">
    <script>createHeader('Entry', true);</script>

    <div class="container">
        <div id="content">
            <div class="loading">Loading entry</div>
        </div>
    </div>

    <script>
        // Extract from URL: /entries/:group/:date/:slug/edit.html
        const pathParts = window.location.pathname.split('/');
        const groupKey = pathParts[2];
        const entryDate = pathParts[3];
        const profileSlug = pathParts[4];

        let entryId = null;
        let currentEntry = null;
        let notesTimer = null;

        async function saveField(fieldName, value, fieldEl) {
            try {
                const response = await apiFetch(`/api/entries/${entryId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [fieldName]: value })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Save failed');
                }

                if (fieldEl) {
                    fieldEl.classList.add('save-ok');
                    setTimeout(() => fieldEl.classList.remove('save-ok'), 1000);
                }
            } catch (error) {
                console.error(`Error saving ${fieldName}:`, error);
                if (fieldEl) {
                    fieldEl.classList.add('save-err');
                    setTimeout(() => fieldEl.classList.remove('save-err'), 2000);
                }
            }
        }

        async function deleteEntry() {
            if (!confirm('Delete this entry? This cannot be undone.')) return;
            try {
                const res = await apiFetch(`/api/entries/${entryId}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('Delete failed');
                if (currentEntry && currentEntry.volunteerEntryCount <= 1 && currentEntry.volunteerSlug) {
                    window.location.href = `/profiles/${encodeURIComponent(currentEntry.volunteerSlug)}/details.html`;
                } else {
                    window.location.href = `/sessions/${encodeURIComponent(groupKey)}/${entryDate}/details.html`;
                }
            } catch (error) {
                console.error('Error deleting entry:', error);
                alert('Failed to delete entry.');
            }
        }

        async function loadEntry() {
            const contentDiv = document.getElementById('content');

            if (!groupKey || !entryDate || !profileSlug) {
                contentDiv.innerHTML = `
                    <div class="empty-state">
                        <p>No entry specified</p>
                        <a href="/sessions.html" class="btn-primary">Back to Sessions</a>
                    </div>
                `;
                return;
            }

            try {
                const response = await apiFetch(`/api/entries/${encodeURIComponent(groupKey)}/${encodeURIComponent(entryDate)}/${encodeURIComponent(profileSlug)}`);

                if (!response.ok) {
                    throw new Error(`API returned ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch entry');
                }

                const entry = result.data;
                entryId = entry.id;
                currentEntry = entry;
                document.title = `${entry.volunteerName || 'Entry'} - DTV Tracker`;

                const groupBadge = entry.isGroup ? '<img src="/svg/group.svg" class="group-badge" alt="Group" title="Group">' : '';
                const memberBadge = isMember(entry) ? '<img src="/svg/member.svg" class="member-badge" alt="Member" title="Member">' : '';
                const sessionUrl = `/sessions/${encodeURIComponent(entry.groupKey)}/${entry.date.substring(0, 10)}/details.html`;
                const profileUrl = entry.volunteerSlug ? `/profiles/${encodeURIComponent(entry.volunteerSlug)}/details.html` : '#';

                contentDiv.innerHTML = `
                    <div class="entry-header">
                        <h1>${escapeHtml(entry.volunteerName || 'Unknown')}${groupBadge}${memberBadge}</h1>
                        <div class="subtitle">${formatDate(entry.date)} &middot; ${escapeHtml(entry.groupName || '')}</div>

                        <div class="nav-buttons">
                            <a class="nav-btn" href="${profileUrl}">View Profile</a>
                            <a class="nav-btn" href="${sessionUrl}">View Session</a>
                        </div>
                    </div>

                    <div class="edit-form">
                        <div class="form-field" id="field-checked">
                            <div class="form-label">Checked In</div>
                            <input type="checkbox" id="inputChecked" ${entry.checkedIn ? 'checked' : ''}>
                        </div>
                        <div class="form-field admin-only" id="field-count">
                            <div class="form-label">Count</div>
                            <input type="number" id="inputCount" min="0" step="1" value="${entry.count}">
                        </div>
                        <div class="form-field" id="field-hours">
                            <div class="form-label">Hours</div>
                            <input type="number" id="inputHours" min="0" step="0.5" value="${entry.hours}">
                        </div>
                        <div class="form-field admin-only" id="field-notes">
                            <div class="form-label">Notes</div>
                            <div style="flex:1">
                                <textarea id="inputNotes" style="width:100%">${escapeHtml(entry.notes || '')}</textarea>
                                <div class="tag-buttons" id="tagButtons"></div>
                            </div>
                        </div>
                    </div>

                    <div class="delete-section admin-only">
                        <button class="btn-delete" onclick="deleteEntry()">Delete Entry</button>
                    </div>
                `;

                renderTagButtons('inputNotes', 'tagButtons');

                // Bind live-save events
                document.getElementById('inputChecked').addEventListener('change', function() {
                    saveField('checkedIn', this.checked, document.getElementById('field-checked'));
                });

                document.getElementById('inputCount').addEventListener('change', function() {
                    const val = parseInt(this.value, 10);
                    if (!isNaN(val) && val >= 0) {
                        saveField('count', val, document.getElementById('field-count'));
                    }
                });

                document.getElementById('inputHours').addEventListener('change', function() {
                    const val = parseFloat(this.value);
                    if (!isNaN(val) && val >= 0) {
                        saveField('hours', val, document.getElementById('field-hours'));
                    }
                });

                document.getElementById('inputNotes').addEventListener('input', function() {
                    clearTimeout(notesTimer);
                    const val = this.value;
                    notesTimer = setTimeout(() => {
                        saveField('notes', val, document.getElementById('field-notes'));
                    }, 500);
                });

            } catch (error) {
                console.error('Error loading entry:', error);
                showError(contentDiv, 'Error Loading Entry', error.message);
            }
        }

        loadEntry();
    </script>
</body>
</html>
