<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - DTV Tracker</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .profile-detail { background: var(--surface); border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
        .profile-detail .subtitle { color: var(--text-light); font-size: 0.95rem; margin-bottom: 0.25rem; }
        .profile-detail .subtitle a { color: var(--green); text-decoration: none; }
        .profile-detail .subtitle a:hover { text-decoration: underline; }
        .profile-title-row { display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 0.5rem; }
        .profile-title-row h1 { color: var(--dark); font-size: 2rem; margin: 0; line-height: 1.3; }
        .profile-actions { display: flex; gap: 0.5rem; align-items: center; flex-shrink: 0; }
        .modal.modal-wide { max-width: 480px; }

        .group-hours-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border); }
        .group-hours-section .section-header { display: flex; align-items: baseline; gap: 0.5rem; margin-bottom: 0.75rem; }
        .group-hours-section h2 { color: var(--dark); font-size: 1.1rem; margin: 0; }
        .group-hours-section .section-hint { color: var(--text-lighter); font-size: 0.85rem; }
        .group-hours-list { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .group-hours-item {
            background: var(--green-tint); padding: 0.4rem 0.9rem; border-radius: 6px;
            font-size: 0.95rem; color: var(--text); display: inline-flex; align-items: center;
            gap: 0.4rem; cursor: pointer;
        }
        .group-hours-item strong { color: var(--green); }
        .regular-checkbox { width: 18px; height: 18px; accent-color: var(--green); cursor: pointer; }
        .regular-checkbox:disabled { opacity: 0.5; }

        .entry-info { display: flex; align-items: center; gap: 0.75rem; flex: 1; min-width: 0; flex-wrap: wrap; }
        .entry-group { font-size: 1.05rem; color: var(--dark); white-space: nowrap; }
        .entry-date { font-size: 0.95rem; color: var(--green); font-weight: 600; white-space: nowrap; }
        .entry-tags { display: flex; gap: 0.3rem; align-items: center; }
        .entry-row { display: flex; align-items: center; gap: 0.75rem; }
        .entry-row .entry-card { flex: 1; min-width: 0; }
        .inline-hours {
            width: 60px; min-height: 44px; text-align: center;
            font-size: 0.95rem; font-weight: 600; font-family: inherit;
            border: 2px solid var(--border); border-radius: 6px;
            background: var(--surface); color: var(--text); flex-shrink: 0;
        }
        .inline-hours:focus { outline: none; border-color: var(--green); }
        .inline-hours-display {
            font-size: 0.95rem; font-weight: 600; color: var(--text-lighter);
            flex-shrink: 0; min-width: 40px; text-align: center;
        }
        #groupSelect {
            padding: 0.4rem 0.6rem; font-size: 0.85rem;
            border: 2px solid var(--border-mid); border-radius: var(--radius);
            font-family: var(--font); background: var(--surface); color: var(--text);
            min-height: 36px;
        }
        #groupSelect:focus { outline: none; border-color: var(--green); }

        .consent-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border); }
        .consent-section h2 { color: var(--dark); font-size: 1.1rem; margin-bottom: 0.75rem; }
        .consent-pills { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .consent-pill {
            display: inline-flex; align-items: center; gap: 0.4rem;
            background: var(--green-tint); padding: 0.35rem 0.75rem; border-radius: 6px;
            font-size: 0.85rem; color: var(--text); cursor: pointer; transition: opacity 0.2s;
        }
        .consent-pill:hover { opacity: 0.8; }
        .consent-pill.status-accepted { background: var(--green-tint); color: var(--green); }
        .consent-pill.status-invited { background: #fff3e0; color: #e67e00; }
        .consent-pill.status-declined { background: #fdecea; color: var(--error); }
        .consent-pill .consent-date { color: inherit; opacity: 0.7; font-size: 0.8rem; }
        .consent-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
        .consent-header h2 { margin-bottom: 0; }
        .btn-add-record {
            font-size: 0.85rem; font-weight: 600; padding: 0.3rem 0.7rem;
            border: 2px solid var(--green); border-radius: 6px;
            background: var(--surface); color: var(--green); cursor: pointer;
            min-height: 32px; transition: all 0.2s;
        }
        .btn-add-record:hover { background: var(--green); color: white; }
        .modal-btn-delete { background: var(--error); color: white; margin-right: auto; }
        .modal-btn-delete:hover { opacity: 0.85; }

        #transferResults > div:hover { background: var(--green-bg); }

        @media (max-width: 600px) {
            .profile-detail { padding: 1.5rem; }
            .profile-title-row { flex-wrap: wrap; }
            .profile-title-row h1 { font-size: 1.5rem; }
            .entry-info { gap: 0.5rem; }
            .entry-group { flex-basis: 100%; }
            .entry-meta { width: auto; }
        }
    </style>
    <script src="/js/common.js"></script>
    <script src="/js/tag-icons.js"></script>
</head>
<body class="detail-page">
    <script>createHeader('Profile', true);</script>

    <div class="container">
        <div id="content">
            <div class="loading">Loading profile</div>
        </div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <h3>Edit Profile</h3>
            <div class="modal-field">
                <label for="editName">Name</label>
                <input type="text" id="editName">
            </div>
            <div class="modal-field">
                <label for="editEmail">Email</label>
                <input type="email" id="editEmail">
            </div>
            <div class="modal-field">
                <label for="editMatchName">Eventbrite Match Name</label>
                <input type="text" id="editMatchName">
            </div>
            <div class="modal-field admin-only">
                <label for="editUser">Username</label>
                <input type="text" id="editUser" placeholder="e.g. andrew.davies@dtv.org.uk">
            </div>
            <div class="modal-field" style="display:flex; align-items:center; gap:0.75rem;">
                <input type="checkbox" id="editIsGroup" style="width:20px; height:20px; accent-color:var(--green); cursor:pointer;">
                <label for="editIsGroup" style="cursor:pointer; margin:0;">Is Group</label>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="confirmEditBtn" onclick="saveProfileEdit()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="transferModal">
        <div class="modal modal-wide">
            <h3>Transfer Profile</h3>
            <p>Transfer all entries, regulars and records to another profile.</p>
            <div class="modal-field">
                <input type="text" id="transferSearch" placeholder="Search by name or email..." autocomplete="off" oninput="filterTransferProfiles(this.value)">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:0.3rem;">
                    <span class="search-hint" id="transferHint" style="font-size:0.85rem; color:var(--text-faint);">Type at least 2 characters</span>
                </div>
            </div>
            <div id="transferResults" style="max-height:200px; overflow-y:auto; margin-bottom:1rem;"></div>
            <div id="transferSelected" style="display:none; background:var(--green-light); border-left:4px solid var(--green); padding:0.75rem 1rem; border-radius:var(--radius); margin-bottom:1rem;">
                <strong id="transferTargetName"></strong>
            </div>
            <div class="modal-field" style="display:flex; align-items:center; gap:0.75rem;">
                <input type="checkbox" id="transferDelete" checked style="width:20px; height:20px; accent-color:var(--green); cursor:pointer;">
                <label for="transferDelete" style="cursor:pointer; margin:0;">Delete this profile after transfer</label>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeTransferModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="confirmTransferBtn" onclick="confirmTransfer()" disabled>Transfer</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="editRecordModal">
        <div class="modal">
            <h3 id="editRecordTitle">Edit Record</h3>
            <div class="modal-field">
                <label for="editRecordStatus">Status</label>
                <select id="editRecordStatus"></select>
            </div>
            <div class="modal-field">
                <label for="editRecordDate">Date</label>
                <input type="date" id="editRecordDate">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-delete" id="deleteRecordBtn" onclick="deleteRecord()">Delete</button>
                <button class="modal-btn modal-btn-cancel" onclick="closeRecordModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="saveRecordBtn" onclick="saveRecord()">Save</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="addRecordModal">
        <div class="modal">
            <h3>Add Record</h3>
            <div class="modal-field">
                <label for="addRecordType">Type</label>
                <select id="addRecordType"></select>
            </div>
            <div class="modal-field">
                <label for="addRecordStatus">Status</label>
                <select id="addRecordStatus"></select>
            </div>
            <div class="modal-field">
                <label for="addRecordDate">Date</label>
                <input type="date" id="addRecordDate">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeAddRecordModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="createRecordBtn" onclick="createRecord()">Add</button>
            </div>
        </div>
    </div>

    <script>
        // Extract slug from URL: /profiles/:slug/details.html
        const pathParts = window.location.pathname.split('/');
        const profileSlug = pathParts[2];

        let allEntries = [];
        let currentFilter = 'thisFy';
        let currentGroup = '';
        let currentProfile = null;
        let canEditHours = false;

        const authReady = apiFetch('/auth/me').then(r => r.json()).then(data => {
            if (data.authenticated) {
                canEditHours = data.user.role === 'admin' ||
                    (data.user.role === 'checkin' && data.user.profileSlug === profileSlug);
            }
        }).catch(() => {});

        function filterByFY(filter) {
            currentFilter = filter;
            document.querySelectorAll('#filterMenu button').forEach(btn => btn.classList.remove('active'));
            const btnMap = { all: 'btnAll', lastFy: 'btnLastFY', thisFy: 'btnThisFY' };
            document.getElementById(btnMap[filter]).classList.add('active');
            const labelMap = { all: 'All', lastFy: 'Last FY', thisFy: 'This FY' };
            document.getElementById('filterLabel').textContent = labelMap[filter];
            document.querySelectorAll('.dropdown-menu.open').forEach(m => m.classList.remove('open'));
            displayStats();
            displayGroups();
            displayEntries();
        }

        function setGroup(value) {
            currentGroup = value;
            displayEntries();
        }

        function openEditModal() {
            if (!currentProfile) return;
            document.getElementById('editName').value = currentProfile.name || '';
            document.getElementById('editEmail').value = currentProfile.email || '';
            document.getElementById('editMatchName').value = currentProfile.matchName || '';
            document.getElementById('editUser').value = currentProfile.user || '';
            document.getElementById('editIsGroup').checked = !!currentProfile.isGroup;
            document.getElementById('editModal').classList.add('visible');
            document.getElementById('editName').focus();
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('visible');
        }

        async function deleteProfile() {
            if (!confirm('Delete this profile? This cannot be undone.')) return;
            try {
                const res = await apiFetch(`/api/profiles/${encodeURIComponent(profileSlug)}`, { method: 'DELETE' });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Delete failed');
                }
                window.location.href = '/volunteers.html';
            } catch (error) {
                console.error('Error deleting profile:', error);
                alert(error.message || 'Failed to delete profile.');
            }
        }

        let transferProfiles = [];
        let transferTargetId = null;

        async function openTransferModal() {
            transferTargetId = null;
            document.getElementById('transferSearch').value = '';
            document.getElementById('transferResults').innerHTML = '';
            document.getElementById('transferHint').textContent = 'Type at least 2 characters';
            document.getElementById('transferSelected').style.display = 'none';
            document.getElementById('confirmTransferBtn').disabled = true;
            document.getElementById('transferDelete').checked = true;
            document.getElementById('transferModal').classList.add('visible');

            if (transferProfiles.length === 0) {
                document.getElementById('transferHint').textContent = 'Loading profiles...';
                try {
                    const res = await apiFetch('/api/profiles');
                    const result = await res.json();
                    if (result.success) transferProfiles = result.data;
                } catch (e) { /* ignore */ }
                document.getElementById('transferHint').textContent = 'Type at least 2 characters';
            }
            document.getElementById('transferSearch').focus();
        }

        function closeTransferModal() {
            document.getElementById('transferModal').classList.remove('visible');
        }

        function filterTransferProfiles(query) {
            const hint = document.getElementById('transferHint');
            const results = document.getElementById('transferResults');
            if (!query || query.length < 2) {
                results.innerHTML = '';
                hint.textContent = 'Type at least 2 characters';
                return;
            }
            const q = query.toLowerCase();
            const matches = transferProfiles.filter(p =>
                p.id !== currentProfile.id &&
                ((p.name && p.name.toLowerCase().includes(q)) ||
                 (p.email && p.email.toLowerCase().includes(q)))
            );
            hint.textContent = matches.length ? `${matches.length} match${matches.length !== 1 ? 'es' : ''}` : 'No matches';
            results.innerHTML = matches.slice(0, 30).map(p => `
                <div class="result-card" onclick="selectTransferTarget(${p.id}, '${escapeHtml(p.name || '')}')" style="padding:0.5rem 0.75rem; cursor:pointer; border-bottom:1px solid var(--border);">
                    <div style="font-weight:600;">${escapeHtml(p.name || 'Unknown')}</div>
                    ${p.email ? `<div style="font-size:0.85rem; color:var(--text-faint);">${escapeHtml(p.email)}</div>` : ''}
                </div>
            `).join('');
        }

        function selectTransferTarget(id, name) {
            transferTargetId = id;
            document.getElementById('transferTargetName').textContent = name;
            document.getElementById('transferSelected').style.display = 'block';
            document.getElementById('transferResults').innerHTML = '';
            document.getElementById('transferSearch').value = '';
            document.getElementById('transferHint').textContent = '';
            document.getElementById('confirmTransferBtn').disabled = false;
        }

        async function confirmTransfer() {
            if (!transferTargetId) return;
            const deleteAfter = document.getElementById('transferDelete').checked;
            const targetName = document.getElementById('transferTargetName').textContent;

            if (!confirm(`Transfer all entries, regulars and records to "${targetName}"?${deleteAfter ? ' This profile will be deleted.' : ''}`)) return;

            const btn = document.getElementById('confirmTransferBtn');
            btn.disabled = true;
            btn.textContent = 'Transferring...';

            try {
                const res = await apiFetch(`/api/profiles/${encodeURIComponent(profileSlug)}/transfer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ targetProfileId: transferTargetId, deleteAfter })
                });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Transfer failed');
                }
                const result = await res.json();
                const d = result.data;
                const parts = [];
                if (d.entriesTransferred) parts.push(`${d.entriesTransferred} entries`);
                if (d.regularsTransferred) parts.push(`${d.regularsTransferred} regulars`);
                if (d.recordsTransferred) parts.push(`${d.recordsTransferred} records`);

                if (d.deleted) {
                    alert(parts.length ? `Transferred: ${parts.join(', ')}` : 'Transfer complete');
                    window.location.href = `/profiles/${encodeURIComponent(d.targetSlug)}/details.html`;
                } else {
                    closeTransferModal();
                    if (parts.length) alert(`Transferred: ${parts.join(', ')}`);
                    loadProfile();
                }
            } catch (error) {
                console.error('Error transferring profile:', error);
                alert(error.message || 'Failed to transfer profile.');
                btn.disabled = false;
                btn.textContent = 'Transfer';
            }
        }

        async function saveProfileEdit() {
            const name = document.getElementById('editName').value.trim();
            const email = document.getElementById('editEmail').value.trim();
            const matchName = document.getElementById('editMatchName').value.trim();
            const user = document.getElementById('editUser').value.trim();
            const isGroup = document.getElementById('editIsGroup').checked;

            if (!name) { alert('Name is required.'); return; }

            const btn = document.getElementById('confirmEditBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const res = await apiFetch(`/api/profiles/${encodeURIComponent(profileSlug)}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, matchName, user, isGroup })
                });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Save failed');
                }
                closeEditModal();
                loadProfile();
            } catch (error) {
                console.error('Error saving profile:', error);
                alert(error.message || 'Failed to save profile.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save';
            }
        }

        async function toggleRegular(checkbox) {
            const groupId = parseInt(checkbox.dataset.groupId);
            const regularId = checkbox.dataset.regularId;
            const isAdding = checkbox.checked;

            checkbox.disabled = true;

            try {
                if (isAdding) {
                    const res = await apiFetch(`/api/profiles/${encodeURIComponent(profileSlug)}/regulars`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ groupId })
                    });
                    if (!res.ok) {
                        const data = await res.json();
                        throw new Error(data.error || 'Failed to add regular');
                    }
                    const result = await res.json();
                    checkbox.dataset.regularId = result.data.id;
                } else {
                    if (!regularId) throw new Error('No regular ID');
                    const res = await apiFetch(`/api/regulars/${regularId}`, { method: 'DELETE' });
                    if (!res.ok) {
                        const data = await res.json();
                        throw new Error(data.error || 'Failed to remove regular');
                    }
                    checkbox.dataset.regularId = '';
                }
            } catch (error) {
                console.error('Error toggling regular:', error);
                checkbox.checked = !isAdding;
                alert(error.message || 'Failed to update regular status.');
            } finally {
                checkbox.disabled = false;
            }
        }

        function displayStats() {
            const el = document.getElementById('statsContainer');
            if (!el || !currentProfile) return;
            const thisFYKey = getFYKey(0);
            const lastFYKey = getFYKey(-1);
            let hours = currentProfile.hoursThisFY + currentProfile.hoursLastFY;
            if (currentFilter === 'thisFy') hours = currentProfile.hoursThisFY;
            else if (currentFilter === 'lastFy') hours = currentProfile.hoursLastFY;
            el.innerHTML = `<div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number">${Math.round(hours * 10) / 10}</div>
                    <div class="stat-label">Hours</div>
                </div>
            </div>`;
        }

        function displayGroups() {
            const container = document.getElementById('groupsContainer');
            if (!container || !currentProfile) return;
            const groups = currentProfile.groupHours || [];
            if (groups.length === 0) {
                container.innerHTML = '';
                return;
            }
            const visible = groups.filter(gh => {
                if (currentFilter === 'thisFy') return gh.hoursThisFY > 0;
                if (currentFilter === 'lastFy') return gh.hoursLastFY > 0;
                return true;
            });
            if (visible.length === 0) {
                container.innerHTML = '<p class="no-sessions">No groups</p>';
                return;
            }
            container.innerHTML = visible.map(gh => {
                let hours = gh.hoursThisFY + gh.hoursLastFY;
                if (currentFilter === 'thisFy') hours = gh.hoursThisFY;
                else if (currentFilter === 'lastFy') hours = gh.hoursLastFY;
                hours = Math.round(hours * 10) / 10;
                return `<label class="group-hours-item">
                    <input type="checkbox" class="regular-checkbox"
                        data-group-id="${gh.groupId}"
                        data-regular-id="${gh.regularId || ''}"
                        ${gh.isRegular ? 'checked' : ''}
                        onchange="toggleRegular(this)">
                    ${escapeHtml(gh.groupName)} <strong>${hours}h</strong>
                </label>`;
            }).join('');
        }

        function displayEntries() {
            const container = document.getElementById('entriesContainer');
            const countEl = document.getElementById('entriesCount');
            if (!container) return;

            const thisFYKey = getFYKey(0);
            const lastFYKey = getFYKey(-1);

            let filtered = allEntries;
            if (currentFilter === 'thisFy') {
                filtered = filtered.filter(e => e.financialYear === thisFYKey);
            } else if (currentFilter === 'lastFy') {
                filtered = filtered.filter(e => e.financialYear === lastFYKey);
            }

            // Populate group select from FY-filtered entries
            const groupSelect = document.getElementById('groupSelect');
            if (groupSelect) {
                const groups = [...new Set(filtered.map(e => e.groupName).filter(Boolean))].sort();
                const prev = groupSelect.value;
                groupSelect.innerHTML = '<option value="">All Groups</option>' +
                    groups.map(g => `<option value="${escapeHtml(g)}"${g === prev ? ' selected' : ''}>${escapeHtml(g)}</option>`).join('');
            }

            if (currentGroup) {
                filtered = filtered.filter(e => e.groupName === currentGroup);
            }

            countEl.textContent = filtered.length;

            if (filtered.length === 0) {
                container.innerHTML = '<p class="no-sessions">No entries</p>';
                return;
            }

            container.innerHTML = '<div class="entries-list">' + filtered.map(entry => {
                const icons = notesToIcons(entry.notes);
                const detailUrl = entry.groupKey && entry.date
                    ? `/entries/${encodeURIComponent(entry.groupKey)}/${entry.date.substring(0, 10)}/${encodeURIComponent(profileSlug)}/edit.html`
                    : '#';
                const hoursHtml = canEditHours
                    ? `<input type="number" class="inline-hours" value="${entry.hours}" min="0" step="0.5"
                           data-entry-id="${entry.id}" data-original="${entry.hours}"
                           onchange="updateEntryHours(this)" onclick="event.stopPropagation()">`
                    : `<span class="inline-hours-display">${entry.hours}h</span>`;
                return `
                    <div class="entry-row">
                        <a class="entry-card${entry.checkedIn ? ' checked-in' : ''}" href="${detailUrl}">
                            <div class="entry-info">
                                ${entry.groupName ? `<span class="entry-group">${escapeHtml(entry.groupName)}</span>` : ''}
                                <span class="entry-date">${formatDate(entry.date)}</span>
                                ${icons ? `<span class="entry-tags">${icons}</span>` : ''}
                            </div>
                            ${entry.count > 1 ? `<div class="entry-meta"><span><strong>Count:</strong> ${entry.count}</span></div>` : ''}
                        </a>
                        ${hoursHtml}
                    </div>
                `;
            }).join('') + '</div>';
        }

        async function loadProfile() {
            const contentDiv = document.getElementById('content');

            if (!profileSlug) {
                contentDiv.innerHTML = `
                    <div class="empty-state">
                        <p>No profile specified</p>
                        <a href="/volunteers.html" class="btn-primary">Back to Volunteers</a>
                    </div>
                `;
                return;
            }

            try {
                await authReady;
                const response = await apiFetch(`/api/profiles/${encodeURIComponent(profileSlug)}`);

                if (!response.ok) {
                    throw new Error(`API returned ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch profile');
                }

                const profile = result.data;
                currentProfile = profile;
                document.title = `${profile.name || 'Profile'} - DTV Tracker`;

                allEntries = profile.entries || [];

                const groupBadge = profile.isGroup ? '<img src="/svg/group.svg" class="group-badge" alt="Group" title="Group">' : '';
                const memberBadge = isMember(profile) ? '<img src="/svg/member.svg" class="member-badge" alt="Member" title="Member">' : '';

                contentDiv.innerHTML = `
                    <div class="profile-detail">
                        <div class="profile-title-row">
                            <h1>${escapeHtml(profile.name || 'Unknown')}${groupBadge}${memberBadge}</h1>
                            <div class="profile-actions">
                                <div class="dropdown">
                                    <button class="dropdown-btn" onclick="toggleDropdown('filterMenu')">
                                        <svg viewBox="0 0 16 16"><path d="M1.5 1.5h13L10 7.5V13l-4 2V7.5z"/></svg>
                                        <span id="filterLabel">This FY</span>
                                    </button>
                                    <div class="dropdown-menu" id="filterMenu">
                                        <button id="btnAll" onclick="filterByFY('all')">All</button>
                                        <button id="btnLastFY" onclick="filterByFY('lastFy')">Last FY</button>
                                        <button id="btnThisFY" class="active" onclick="filterByFY('thisFy')">This FY</button>
                                    </div>
                                </div>
                                <button class="btn-action checkin-only" onclick="openEditModal()" title="Edit profile">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                        <path d="m15 5 4 4"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        ${profile.email ? `<div class="subtitle"><a href="mailto:${encodeURIComponent(profile.email)}">${escapeHtml(profile.email)}</a></div>` : ''}
                        <div class="stats-section">
                            <div id="statsContainer"></div>
                        </div>
                        ${profile.groupHours && profile.groupHours.length > 0 ? `
                        <div class="group-hours-section">
                            <div class="section-header">
                                <h2>Groups</h2>
                                <span class="section-hint">Regular Attendee</span>
                            </div>
                            <div class="group-hours-list" id="groupsContainer"></div>
                        </div>` : ''}
                        <div class="consent-section">
                            <div class="consent-header">
                                <h2>Records</h2>
                                <button class="btn-add-record admin-only" onclick="openAddRecord()">+ Add</button>
                            </div>
                            <div class="consent-pills">
                                ${(profile.records || []).map(r => `<span class="consent-pill admin-clickable status-${(r.status || '').toLowerCase()}" onclick="openEditRecord(${r.id}, '${escapeHtml(r.type).replace(/'/g, "\\'")}', '${escapeHtml(r.status || '').replace(/'/g, "\\'")}', '${r.date || ''}')">${escapeHtml(r.type)} <span class="consent-date">${escapeHtml(r.status || '')}${r.date ? ' Â· ' + formatDate(r.date) : ''}</span></span>`).join('')}
                                ${(!profile.records || profile.records.length === 0) ? '<span style="color:var(--text-faint); font-size:0.85rem;">No records</span>' : ''}
                            </div>
                        </div>
                    </div>

                    <div class="filter-bar">
                        <div class="title-row">
                            <div class="title-left">
                                <h2>Entries</h2>
                                <div class="count" id="entriesCount"></div>
                            </div>
                            <select id="groupSelect" onchange="setGroup(this.value)">
                                <option value="">All Groups</option>
                            </select>
                        </div>
                    </div>
                    <div id="entriesContainer"></div>
                    <div class="delete-section admin-only">
                        <button class="btn-delete" onclick="openTransferModal()">Transfer</button>
                        ${allEntries.length === 0 ? '<button class="btn-delete" onclick="deleteProfile()" style="margin-left:0.5rem;">Delete Profile</button>' : ''}
                    </div>
                `;

                displayStats();
                displayGroups();
                displayEntries();

            } catch (error) {
                console.error('Error loading profile:', error);
                showError(contentDiv, 'Error Loading Profile', error.message);
            }
        }

        loadProfile();

        async function updateEntryHours(input) {
            const entryId = input.dataset.entryId;
            const original = parseFloat(input.dataset.original);
            const hours = parseFloat(input.value);

            if (isNaN(hours) || hours < 0) {
                input.value = original;
                return;
            }

            try {
                const res = await apiFetch(`/api/entries/${entryId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ hours })
                });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Save failed');
                }
                input.dataset.original = hours;
            } catch (error) {
                input.value = original;
                alert(error.message || 'Failed to update hours.');
            }
        }

        // === Records management ===
        let recordOptions = null;
        let editingRecordId = null;

        async function loadRecordOptions() {
            if (recordOptions) return recordOptions;
            try {
                const res = await apiFetch('/api/records/options');
                const data = await res.json();
                if (data.success) recordOptions = data.data;
            } catch (e) { console.error('Failed to load record options:', e); }
            return recordOptions || { types: [], statuses: [] };
        }

        function populateSelect(selectEl, options, selected) {
            selectEl.innerHTML = options.map(o =>
                `<option value="${escapeHtml(o)}"${o === selected ? ' selected' : ''}>${escapeHtml(o)}</option>`
            ).join('');
        }

        function toDateInputValue(isoStr) {
            if (!isoStr) return '';
            return new Date(isoStr).toISOString().substring(0, 10);
        }

        async function openEditRecord(id, type, status, date) {
            editingRecordId = id;
            const opts = await loadRecordOptions();
            document.getElementById('editRecordTitle').textContent = type;
            populateSelect(document.getElementById('editRecordStatus'), opts.statuses, status);
            document.getElementById('editRecordDate').value = toDateInputValue(date);
            document.getElementById('editRecordModal').classList.add('visible');
        }

        function closeRecordModal() {
            document.getElementById('editRecordModal').classList.remove('visible');
            editingRecordId = null;
        }

        async function saveRecord() {
            if (!editingRecordId) return;
            const btn = document.getElementById('saveRecordBtn');
            btn.disabled = true; btn.textContent = 'Saving...';
            try {
                const status = document.getElementById('editRecordStatus').value;
                const dateVal = document.getElementById('editRecordDate').value;
                const date = dateVal ? new Date(dateVal + 'T10:00:00.000Z').toISOString() : undefined;
                const res = await apiFetch(`/api/records/${editingRecordId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status, date })
                });
                if (!res.ok) { const d = await res.json(); throw new Error(d.error || 'Save failed'); }
                closeRecordModal();
                loadProfile();
            } catch (error) {
                alert(error.message || 'Failed to save record.');
            } finally {
                btn.disabled = false; btn.textContent = 'Save';
            }
        }

        async function deleteRecord() {
            if (!editingRecordId) return;
            if (!confirm('Delete this record?')) return;
            const btn = document.getElementById('deleteRecordBtn');
            btn.disabled = true; btn.textContent = 'Deleting...';
            try {
                const res = await apiFetch(`/api/records/${editingRecordId}`, { method: 'DELETE' });
                if (!res.ok) { const d = await res.json(); throw new Error(d.error || 'Delete failed'); }
                closeRecordModal();
                loadProfile();
            } catch (error) {
                alert(error.message || 'Failed to delete record.');
            } finally {
                btn.disabled = false; btn.textContent = 'Delete';
            }
        }

        async function openAddRecord() {
            const opts = await loadRecordOptions();
            populateSelect(document.getElementById('addRecordType'), opts.types, '');
            populateSelect(document.getElementById('addRecordStatus'), opts.statuses, '');
            document.getElementById('addRecordDate').value = new Date().toISOString().substring(0, 10);
            document.getElementById('addRecordModal').classList.add('visible');
        }

        function closeAddRecordModal() {
            document.getElementById('addRecordModal').classList.remove('visible');
        }

        async function createRecord() {
            if (!currentProfile) return;
            const btn = document.getElementById('createRecordBtn');
            btn.disabled = true; btn.textContent = 'Adding...';
            try {
                const type = document.getElementById('addRecordType').value;
                const status = document.getElementById('addRecordStatus').value;
                const dateVal = document.getElementById('addRecordDate').value;
                const date = dateVal ? new Date(dateVal + 'T10:00:00.000Z').toISOString() : new Date().toISOString();
                const res = await apiFetch(`/api/profiles/${currentProfile.id}/records`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, status, date })
                });
                if (!res.ok) { const d = await res.json(); throw new Error(d.error || 'Create failed'); }
                closeAddRecordModal();
                loadProfile();
            } catch (error) {
                alert(error.message || 'Failed to create record.');
            } finally {
                btn.disabled = false; btn.textContent = 'Add';
            }
        }
    </script>
</body>
</html>
