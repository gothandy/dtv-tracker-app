<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Details - DTV Tracker</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .group-detail { background: var(--surface); border-radius: var(--radius); padding: 1.5rem; box-shadow: var(--shadow); margin-bottom: 1.5rem; }
        .group-title-row { display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .group-title-row h2 { font-size: 1.3rem; color: var(--dark); margin: 0; }
        .group-detail .description { color: var(--text-mid); font-size: 1.05rem; line-height: 1.7; white-space: pre-wrap; }

        .regulars-section { background: var(--surface); border-radius: var(--radius); padding: 1.25rem 1.5rem; box-shadow: var(--shadow); margin-bottom: 1.5rem; }
        .regulars-section h2 { color: var(--dark); font-size: 1.1rem; margin-bottom: 0.75rem; }
        .regulars-list { list-style: none; display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .regulars-list li { background: var(--green-tint); padding: 0.4rem 0.9rem; border-radius: 6px; font-size: 0.95rem; color: var(--text); }
        .regulars-list a { color: inherit; text-decoration: none; }
        .regulars-list a:hover { text-decoration: underline; color: var(--green); }

        .modal-btn-delete { background: var(--error); color: white; }
        .modal-btn-delete:hover { opacity: 0.85; }

        @media (max-width: 600px) {
            .group-detail { padding: 1.25rem; }
            .group-title-row { flex-wrap: wrap; }
        }
    </style>
    <script src="/js/common.js"></script>
</head>
<body class="detail-page">
    <script>createHeader('Group Details', true);</script>

    <div class="container">
        <div id="content">
            <div class="loading">Loading group details</div>
        </div>
    </div>

    <!-- Edit Group Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <h3>Edit Group</h3>
            <div class="modal-field">
                <label for="editName">Display Name</label>
                <input type="text" id="editName">
            </div>
            <div class="modal-field">
                <label for="editDescription">Description</label>
                <textarea id="editDescription"></textarea>
            </div>
            <div class="modal-field">
                <label for="editKey">Key Name</label>
                <input type="text" id="editKey" placeholder="e.g. sat">
            </div>
            <div class="modal-field">
                <label for="editEventbriteId">Eventbrite Series ID</label>
                <input type="text" id="editEventbriteId" placeholder="e.g. 123456789">
            </div>
            <div class="modal-buttons" style="justify-content: space-between;">
                <button class="modal-btn modal-btn-delete" onclick="deleteGroup()">Delete</button>
                <div style="display:flex; gap:0.5rem;">
                    <button class="modal-btn modal-btn-cancel" onclick="closeEditModal()">Cancel</button>
                    <button class="modal-btn modal-btn-confirm" id="confirmEditBtn" onclick="saveGroupEdit()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Session Modal -->
    <div class="modal-overlay" id="newSessionModal">
        <div class="modal">
            <h3>New Session</h3>
            <div class="modal-field">
                <label for="newSessionGroup">Group</label>
                <select id="newSessionGroup" disabled></select>
            </div>
            <div class="modal-field">
                <label for="newSessionDate">Date</label>
                <input type="date" id="newSessionDate">
            </div>
            <div class="modal-field">
                <label for="newSessionName">Name (optional)</label>
                <input type="text" id="newSessionName">
            </div>
            <div class="modal-field">
                <label for="newSessionDescription">Description (optional)</label>
                <textarea id="newSessionDescription"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeNewSessionModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="confirmNewSessionBtn" onclick="saveNewSession()">Create</button>
            </div>
        </div>
    </div>

    <script>
        const pathParts = window.location.pathname.split('/');
        const groupKey = pathParts[2];

        let currentGroup = null;
        let allSessions = [];
        let currentFilter = 'thisFy';

        function filterByFY(filter) {
            currentFilter = filter;
            const labels = { all: 'All', lastFy: 'Last FY', thisFy: 'This FY', future: 'Future' };
            document.getElementById('filterLabel').textContent = labels[filter];
            ['btnAll', 'btnLastFY', 'btnThisFY', 'btnFuture'].forEach(id => {
                document.getElementById(id).classList.remove('active');
            });
            const btnMap = { all: 'btnAll', lastFy: 'btnLastFY', thisFy: 'btnThisFY', future: 'btnFuture' };
            document.getElementById(btnMap[filter]).classList.add('active');
            document.querySelectorAll('.dropdown-menu.open').forEach(m => m.classList.remove('open'));
            displayStats();
            displaySessions();
        }

        function getFilteredSessions() {
            const thisFYKey = getFYKey(0);
            const lastFYKey = getFYKey(-1);
            const nextDate = findNextSessionDate(allSessions);

            if (currentFilter === 'thisFy') {
                return allSessions.filter(s => {
                    if (s.financialYear !== thisFYKey) return false;
                    if (!nextDate || !s.date) return true;
                    const d = new Date(s.date);
                    d.setHours(0, 0, 0, 0);
                    return d <= nextDate;
                });
            } else if (currentFilter === 'lastFy') {
                return allSessions.filter(s => s.financialYear === lastFYKey);
            } else if (currentFilter === 'future') {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                return allSessions.filter(s => {
                    if (!s.date) return false;
                    const d = new Date(s.date);
                    d.setHours(0, 0, 0, 0);
                    return d >= today;
                });
            }
            return allSessions;
        }

        function displayStats() {
            const statsContainer = document.getElementById('statsContainer');
            if (!statsContainer || !currentGroup) return;

            const filtered = getFilteredSessions();
            const sessions = filtered.length;
            const hours = Math.round(filtered.reduce((sum, s) => sum + (s.hours || 0), 0) * 10) / 10;
            const registrations = filtered.reduce((sum, s) => sum + (s.registrations || 0), 0);

            statsContainer.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number">${sessions}</div>
                        <div class="stat-label">Sessions</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${hours}</div>
                        <div class="stat-label">Hours</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">${registrations}</div>
                        <div class="stat-label">Entries</div>
                    </div>
                </div>
            `;
        }

        function displaySessions() {
            const container = document.getElementById('sessionsContainer');
            if (!container) return;
            const filtered = getFilteredSessions();
            renderSessionList(container, filtered, { showGroup: false });
        }

        // Edit modal
        function openEditModal() {
            if (!currentGroup) return;
            document.getElementById('editName').value = currentGroup.displayName || '';
            document.getElementById('editDescription').value = currentGroup.description || '';
            document.getElementById('editKey').value = currentGroup.key || '';
            document.getElementById('editEventbriteId').value = currentGroup.eventbriteSeriesId || '';
            document.getElementById('editModal').classList.add('visible');
            document.getElementById('editName').focus();
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('visible');
        }

        async function saveGroupEdit() {
            const displayName = document.getElementById('editName').value.trim();
            const description = document.getElementById('editDescription').value;
            const key = document.getElementById('editKey').value.trim();
            const eventbriteSeriesId = document.getElementById('editEventbriteId').value.trim();

            if (!key) {
                document.getElementById('editKey').focus();
                return;
            }

            if (key.toLowerCase() !== (currentGroup.key || '').toLowerCase()) {
                if (!confirm(`Changing the Key Name will update all session titles for this group and redirect you to the new URL. Continue?`)) return;
            }

            const btn = document.getElementById('confirmEditBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const res = await apiFetch(`/api/groups/${encodeURIComponent(groupKey)}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key, displayName, description, eventbriteSeriesId })
                });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Save failed');
                }
                const result = await res.json();
                closeEditModal();
                const newKey = result.data?.key;
                if (newKey && newKey !== groupKey) {
                    window.location.href = `/groups/${encodeURIComponent(newKey)}/details.html`;
                } else {
                    loadGroupDetail();
                }
            } catch (error) {
                console.error('Error saving group:', error);
                alert(error.message || 'Failed to save group.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save';
            }
        }

        async function deleteGroup() {
            if (!currentGroup) return;
            if (!confirm(`Delete "${currentGroup.displayName}"? This cannot be undone.`)) return;

            try {
                const res = await apiFetch(`/api/groups/${encodeURIComponent(groupKey)}`, { method: 'DELETE' });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Delete failed');
                }
                window.location.href = '/groups.html';
            } catch (error) {
                console.error('Error deleting group:', error);
                alert(error.message || 'Failed to delete group.');
            }
        }

        // New session modal
        function openNewSessionModal() {
            const select = document.getElementById('newSessionGroup');
            select.innerHTML = `<option value="${currentGroup.id}">${escapeHtml(currentGroup.displayName || groupKey)}</option>`;
            document.getElementById('newSessionDate').value = '';
            document.getElementById('newSessionName').value = '';
            document.getElementById('newSessionDescription').value = '';
            document.getElementById('newSessionModal').classList.add('visible');
            document.getElementById('newSessionDate').focus();
        }

        function closeNewSessionModal() {
            document.getElementById('newSessionModal').classList.remove('visible');
        }

        async function saveNewSession() {
            const date = document.getElementById('newSessionDate').value;
            const name = document.getElementById('newSessionName').value.trim();
            const description = document.getElementById('newSessionDescription').value.trim();

            if (!date) {
                document.getElementById('newSessionDate').focus();
                return;
            }

            const btn = document.getElementById('confirmNewSessionBtn');
            btn.disabled = true;
            btn.textContent = 'Creating...';

            try {
                const res = await apiFetch('/api/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ groupId: currentGroup.id, date, name: name || undefined, description: description || undefined })
                });

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Failed to create session');
                }

                const result = await res.json();
                closeNewSessionModal();
                window.location.href = `/sessions/${encodeURIComponent(result.data.groupKey)}/${result.data.date}/details.html`;
            } catch (error) {
                console.error('Error creating session:', error);
                alert(error.message || 'Failed to create session.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create';
            }
        }

        async function loadGroupDetail() {
            const contentDiv = document.getElementById('content');

            if (!groupKey) {
                contentDiv.innerHTML = '<div class="empty-state"><p>No group specified</p></div>';
                return;
            }

            try {
                const response = await fetch(`/api/groups/${encodeURIComponent(groupKey)}`);
                if (!response.ok) throw new Error(`API returned ${response.status}: ${response.statusText}`);
                const result = await response.json();
                if (!result.success) throw new Error(result.error || 'Failed to fetch group');

                const group = result.data;
                currentGroup = group;
                allSessions = group.sessions || [];
                document.title = `${group.displayName} - DTV Tracker`;

                const eventbriteBtn = group.eventbriteSeriesId
                    ? buildEventbriteLink(`https://www.eventbrite.co.uk/e/${group.eventbriteSeriesId}`)
                    : '';

                const editBtn = `
                    <button class="btn-action admin-only" onclick="openEditModal()" title="Edit group">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                            <path d="m15 5 4 4"/>
                        </svg>
                    </button>`;

                const regulars = group.regulars || [];
                const regularsSection = regulars.length > 0
                    ? `<div class="regulars-section">
                            <h2>Regulars (${regulars.length})</h2>
                            <ul class="regulars-list">
                                ${regulars.map(r => `<li><a href="/profiles/${encodeURIComponent(r.slug)}/details.html">${escapeHtml(r.name)}</a></li>`).join('')}
                            </ul>
                       </div>`
                    : '';

                contentDiv.innerHTML = `
                    <div class="group-detail">
                        <div class="group-title-row">
                            <h2>${escapeHtml(group.displayName)}</h2>
                            <div style="display:flex; gap:0.5rem;">
                                <div class="dropdown">
                                    <button class="dropdown-btn" onclick="toggleDropdown('filterMenu')">
                                        <svg viewBox="0 0 16 16"><path d="M1.5 1.5h13L10 7.5V13l-4 2V7.5z"/></svg>
                                        <span id="filterLabel">This FY</span>
                                    </button>
                                    <div class="dropdown-menu" id="filterMenu">
                                        <button id="btnAll" onclick="filterByFY('all')">All</button>
                                        <button id="btnLastFY" onclick="filterByFY('lastFy')">Last FY</button>
                                        <button id="btnThisFY" class="active" onclick="filterByFY('thisFy')">This FY</button>
                                        <button id="btnFuture" onclick="filterByFY('future')">Future</button>
                                    </div>
                                </div>
                                ${eventbriteBtn}
                                ${editBtn}
                            </div>
                        </div>
                        ${group.description ? `<div class="description" style="margin-bottom:1.25rem;">${escapeHtml(group.description)}</div>` : ''}
                        <div id="statsContainer"></div>
                    </div>

                    ${regularsSection}

                    <div class="filter-bar">
                        <div class="title-row">
                            <div class="title-left">
                                <h2>Sessions</h2>
                            </div>
                            <button class="btn-action admin-only" onclick="openNewSessionModal()">
                                <svg viewBox="0 0 16 16"><path d="M8 2v12M2 8h12" stroke="white" stroke-width="2" stroke-linecap="round" fill="none"/></svg>
                            </button>
                        </div>
                    </div>
                    <div id="sessionsContainer"></div>
                `;

                clampDescriptions(contentDiv);
                initEventbriteButtons(contentDiv);
                displayStats();
                displaySessions();
                attachPhotoCounts(allSessions).then(() => displaySessions());

            } catch (error) {
                console.error('Error loading group detail:', error);
                showError(contentDiv, 'Error Loading Group Details', error.message);
            }
        }

        loadGroupDetail();
    </script>
</body>
</html>
