<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Details - DTV Tracker</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        body { min-height: 100vh; display: flex; flex-direction: column; }
        .container { max-width: 900px; padding: 1.5rem; flex: 1; }

        .group-detail { background: var(--surface); border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
        .group-detail h1 { color: var(--green); font-size: 2rem; margin-bottom: 0.5rem; line-height: 1.3; }
        .group-detail .description { color: var(--text-mid); font-size: 1.1rem; line-height: 1.7; margin-bottom: 1.5rem; white-space: pre-wrap; }

        .eventbrite-button {
            display: inline-flex; background-color: var(--green); color: white;
            padding: 1rem 2rem; border-radius: var(--radius); text-decoration: none;
            font-weight: 600; font-size: 1.1rem; transition: background 0.2s;
            min-height: 52px; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .eventbrite-button:hover { background-color: var(--green-dark); }

        .stats-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border); }
        .stats-section .fy-label { color: var(--text-faint); font-size: 0.9rem; margin-bottom: 0.75rem; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.75rem; }
        .stat-item { text-align: center; padding: 0.75rem 0.5rem; background: var(--green-bg); border-radius: var(--radius); }
        .stat-item .stat-number { font-size: 1.8rem; font-weight: bold; color: var(--green); line-height: 1; }
        .stat-item .stat-label { font-size: 0.8rem; color: var(--text-light); margin-top: 0.25rem; }

        .regulars-section { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border); }
        .regulars-section h2 { color: var(--green); font-size: 1.3rem; margin-bottom: 1rem; }
        .regulars-list { list-style: none; display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .regulars-list li { background: var(--green-tint); padding: 0.4rem 0.9rem; border-radius: 6px; font-size: 0.95rem; color: var(--text); }

        .sessions-heading { color: var(--green); font-size: 1.3rem; margin-bottom: 1rem; }

        @media (max-width: 600px) {
            .group-detail { padding: 1.5rem; }
            .group-detail h1 { font-size: 1.75rem; }
            .stat-item .stat-number { font-size: 1.5rem; }
        }
    </style>
    <script src="/js/common.js"></script>
</head>
<body>
    <script>createHeader('Group Details', true);</script>

    <div class="container">
        <div id="content">
            <div class="loading">Loading group details</div>
        </div>
    </div>

    <script>
        // Extract group key from URL path: /groups/:key/detail.html
        const pathParts = window.location.pathname.split('/');
        const groupKey = pathParts[2];

        async function loadGroupDetail() {
            const contentDiv = document.getElementById('content');

            if (!groupKey) {
                contentDiv.innerHTML = `
                    <div class="empty-state">
                        <p>No group specified</p>
                        <a href="/groups.html" class="back-button">Back to Groups</a>
                    </div>
                `;
                return;
            }

            try {
                const response = await fetch(`/api/groups/${encodeURIComponent(groupKey)}`);

                if (!response.ok) {
                    throw new Error(`API returned ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch group');
                }

                const group = result.data;
                document.title = `${group.displayName} - DTV Tracker`;

                const eventbriteButton = group.eventbriteSeriesId
                    ? `<a href="https://www.eventbrite.co.uk/e/${group.eventbriteSeriesId}" target="_blank" class="eventbrite-button">
                            View on Eventbrite &rarr;
                       </a>`
                    : '';

                const stats = group.stats;
                const statsSection = `
                    <div class="stats-section">
                        <div class="fy-label">FY ${group.financialYear}</div>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-number">${stats.sessions}</div>
                                <div class="stat-label">Sessions</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${stats.hours}</div>
                                <div class="stat-label">Hours</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${stats.newVolunteers}</div>
                                <div class="stat-label">New</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${stats.children}</div>
                                <div class="stat-label">Children</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${stats.totalVolunteers}</div>
                                <div class="stat-label">Volunteers</div>
                            </div>
                        </div>
                    </div>
                `;

                const regulars = group.regulars || [];
                const regularsSection = regulars.length > 0
                    ? `<div class="regulars-section">
                            <h2>Regulars (${regulars.length})</h2>
                            <ul class="regulars-list">
                                ${regulars.map(name => `<li>${escapeHtml(name)}</li>`).join('')}
                            </ul>
                       </div>`
                    : '';

                // Combine next + recent into a single flat list
                const allSessions = [];
                if (group.nextSession) allSessions.push(group.nextSession);
                if (group.recentSessions) allSessions.push(...group.recentSessions);

                contentDiv.innerHTML = `
                    <div class="group-detail">
                        <h1>${escapeHtml(group.displayName)}</h1>
                        ${group.description ? `<div class="description">${escapeHtml(group.description)}</div>` : ''}
                        ${eventbriteButton}
                        ${statsSection}
                        ${regularsSection}
                    </div>
                    ${allSessions.length > 0 ? '<h2 class="sessions-heading">Sessions</h2><div id="sessionsContainer"></div>' : ''}
                `;

                clampDescriptions(contentDiv);

                // Render sessions using the shared component
                if (allSessions.length > 0) {
                    const container = document.getElementById('sessionsContainer');
                    renderSessionList(container, allSessions, { showGroup: false });
                }

            } catch (error) {
                console.error('Error loading group detail:', error);
                showError(contentDiv, 'Error Loading Group Details', error.message);
            }
        }

        loadGroupDetail();
    </script>
</body>
</html>
