<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Groups - DTV Tracker</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .groups-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(min(350px, 100%), 1fr)); gap: 1.5rem; }
        .group-card {
            background: var(--surface); border-radius: var(--radius); padding: 1.5rem;
            box-shadow: var(--shadow); transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer; text-decoration: none; color: inherit; display: block;
        }
        .group-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }
        .group-card h3 { color: var(--dark); margin-bottom: 0.5rem; font-size: 1.3rem; }
        .group-card .description { color: var(--text-mid); margin-bottom: 1rem; line-height: 1.5; }
        .group-card .meta { display: flex; gap: 1rem; flex-wrap: wrap; font-size: 0.85rem; color: var(--text-lighter); border-top: 1px solid var(--border); padding-top: 1rem; }
        .group-card .meta-item { display: flex; align-items: center; gap: 0.3rem; }
        .group-card .meta-item strong { color: var(--text-mid); }

        .modal-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4);
            z-index: 100; align-items: center; justify-content: center;
        }
        .modal-overlay.visible { display: flex; }
        .modal {
            background: var(--surface); border-radius: var(--radius); padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2); width: 90%; max-width: 400px;
        }
        .modal h3 { color: var(--dark); margin-bottom: 1rem; font-size: 1.1rem; }
        .modal-field { margin-bottom: 1rem; }
        .modal-field label { display: block; font-size: 0.85rem; color: var(--text-light); margin-bottom: 0.3rem; }
        .modal-field input[type="text"], .modal-field textarea {
            width: 100%; font-size: 1rem; padding: 0.6rem 0.75rem;
            border: 2px solid var(--border-mid); border-radius: 6px; font-family: inherit;
        }
        .modal-field textarea { min-height: 60px; resize: vertical; }
        .modal-field input:focus, .modal-field textarea:focus { outline: none; border-color: var(--green); }
        .modal-buttons { display: flex; gap: 0.5rem; justify-content: flex-end; }
        .modal-btn {
            padding: 0.5rem 1rem; border-radius: var(--radius); font-size: 0.9rem;
            font-weight: 600; cursor: pointer; border: none; min-height: 40px;
        }
        .modal-btn-cancel { background: var(--bg); color: var(--text-light); }
        .modal-btn-confirm { background: var(--green); color: white; }
        .modal-btn-confirm:hover { background: var(--green-dark); }
    </style>
    <script src="/js/common.js"></script>
</head>
<body>
    <script>createHeader('Volunteer Groups', true);</script>

    <div class="container">
        <div class="filter-bar">
            <div class="title-row">
                <div class="title-left">
                    <h2>Groups</h2>
                    <div class="count" id="groupCount">-</div>
                </div>
                <div style="display:flex; gap:0.5rem;">
                    <div class="dropdown">
                        <button class="dropdown-btn" id="filterMenuBtn" onclick="toggleDropdown('filterMenu')">
                            <svg viewBox="0 0 16 16"><path d="M1.5 1.5h13L10 7.5V13l-4 2V7.5z"/></svg>
                            <span id="filterLabel">This FY</span>
                        </button>
                        <div class="dropdown-menu" id="filterMenu">
                            <button id="btnAll" onclick="filterGroups('all')">All</button>
                            <button id="btnLastFY" onclick="filterGroups('lastFy')">Last FY</button>
                            <button id="btnThisFY" class="active" onclick="filterGroups('thisFy')">This FY</button>
                        </div>
                    </div>
                    <button class="btn-action" onclick="openNewGroupModal()">
                        <svg viewBox="0 0 16 16"><path d="M8 2v12M2 8h12" stroke="white" stroke-width="2" stroke-linecap="round" fill="none"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <div id="content">
            <div class="loading">Loading groups</div>
        </div>
    </div>

    <div class="modal-overlay" id="newGroupModal">
        <div class="modal">
            <h3>New Group</h3>
            <div class="modal-field">
                <label for="newKey">Key (short name, e.g. "Sat")</label>
                <input type="text" id="newKey">
            </div>
            <div class="modal-field">
                <label for="newName">Display Name (e.g. "Saturday Dig")</label>
                <input type="text" id="newName">
            </div>
            <div class="modal-field">
                <label for="newDescription">Description (optional)</label>
                <textarea id="newDescription"></textarea>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeNewGroupModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="confirmNewBtn" onclick="saveNewGroup()">Create</button>
            </div>
        </div>
    </div>

    <script>
        let allGroups = [];
        let allSessions = [];
        let currentFilter = 'thisFy';

        function getActiveGroupIds(fyKey) {
            const activeGroupIds = new Set();
            allSessions.forEach(session => {
                if (session.financialYear === fyKey && session.groupId) {
                    activeGroupIds.add(session.groupId);
                }
            });
            return activeGroupIds;
        }

        function toggleDropdown(menuId) {
            const menu = document.getElementById(menuId);
            const wasOpen = menu.classList.contains('open');
            document.querySelectorAll('.dropdown-menu.open').forEach(m => m.classList.remove('open'));
            if (!wasOpen) menu.classList.add('open');
        }

        document.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown-menu.open').forEach(m => m.classList.remove('open'));
            }
        });

        function filterGroups(filter) {
            currentFilter = filter;
            const labels = { all: 'All', lastFy: 'Last FY', thisFy: 'This FY' };
            document.getElementById('filterLabel').textContent = labels[filter];
            ['btnAll', 'btnLastFY', 'btnThisFY'].forEach(id => {
                document.getElementById(id).classList.remove('active');
            });
            const btnMap = { all: 'btnAll', lastFy: 'btnLastFY', thisFy: 'btnThisFY' };
            document.getElementById(btnMap[filter]).classList.add('active');
            document.querySelectorAll('.dropdown-menu.open').forEach(m => m.classList.remove('open'));
            displayGroups();
        }

        function displayGroups() {
            const contentDiv = document.getElementById('content');
            const countDiv = document.getElementById('groupCount');

            let filteredGroups = allGroups;
            if (currentFilter === 'thisFy' || currentFilter === 'lastFy') {
                const fyKey = getFYKey(currentFilter === 'lastFy' ? -1 : 0);
                const activeGroupIds = getActiveGroupIds(fyKey);
                filteredGroups = allGroups.filter(g => activeGroupIds.has(g.id));
            }

            countDiv.textContent = filteredGroups.length;

            if (filteredGroups.length === 0) {
                contentDiv.innerHTML = '<div class="empty-state"><p>No groups found</p></div>';
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'groups-grid';

            filteredGroups.forEach(group => {
                const card = document.createElement('a');
                card.className = 'group-card';
                card.href = `/groups/${group.key}/detail.html`;

                const eventbriteLink = group.eventbriteSeriesId
                    ? `<a href="https://www.eventbrite.co.uk/e/${group.eventbriteSeriesId}" target="_blank" style="color: var(--green); text-decoration: none;" onclick="event.stopPropagation();">View on Eventbrite &rarr;</a>`
                    : '';

                card.innerHTML = `
                    <h3>${escapeHtml(group.displayName)}</h3>
                    ${group.description ? `<div class="description">${escapeHtml(group.description)}</div>` : ''}
                    <div class="meta">
                        ${group.regularsCount ? `
                            <div class="meta-item">
                                <strong>${group.regularsCount}</strong> ${group.regularsCount === 1 ? 'regular' : 'regulars'}
                            </div>
                        ` : ''}
                        ${group.eventbriteSeriesId ? `
                            <div class="meta-item">
                                ${eventbriteLink}
                            </div>
                        ` : ''}
                    </div>
                `;

                grid.appendChild(card);
            });

            contentDiv.innerHTML = '';
            contentDiv.appendChild(grid);
        }

        async function loadGroups() {
            const contentDiv = document.getElementById('content');
            const countDiv = document.getElementById('groupCount');

            try {
                const [groupsResponse, sessionsResponse] = await Promise.all([
                    fetch('/api/groups'),
                    fetch('/api/sessions')
                ]);

                if (!groupsResponse.ok || !sessionsResponse.ok) {
                    throw new Error('API request failed');
                }

                const groupsData = await groupsResponse.json();
                const sessionsData = await sessionsResponse.json();

                if (!groupsData.success || !sessionsData.success) {
                    throw new Error('Failed to fetch data');
                }

                allGroups = groupsData.data;
                allSessions = sessionsData.data;
                displayGroups();

            } catch (error) {
                console.error('Error loading groups:', error);
                countDiv.textContent = '?';
                showError(contentDiv, 'Error Loading Groups', error.message);
            }
        }

        function openNewGroupModal() {
            document.getElementById('newKey').value = '';
            document.getElementById('newName').value = '';
            document.getElementById('newDescription').value = '';
            document.getElementById('newGroupModal').classList.add('visible');
            document.getElementById('newKey').focus();
        }

        function closeNewGroupModal() {
            document.getElementById('newGroupModal').classList.remove('visible');
        }

        async function saveNewGroup() {
            const key = document.getElementById('newKey').value.trim();
            const name = document.getElementById('newName').value.trim();
            const description = document.getElementById('newDescription').value.trim();

            if (!key) {
                document.getElementById('newKey').focus();
                return;
            }

            const btn = document.getElementById('confirmNewBtn');
            btn.disabled = true;
            btn.textContent = 'Creating...';

            try {
                const res = await apiFetch('/api/groups', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key, name: name || undefined, description: description || undefined })
                });

                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Failed to create group');
                }

                const result = await res.json();
                closeNewGroupModal();
                window.location.href = `/groups/${encodeURIComponent(result.data.key)}/detail.html`;
            } catch (error) {
                console.error('Error creating group:', error);
                alert(error.message || 'Failed to create group.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create';
            }
        }

        loadGroups();
    </script>
</body>
</html>
