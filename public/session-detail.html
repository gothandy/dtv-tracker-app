<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Details - DTV Tracker</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .session-detail { background: var(--surface); border-radius: 12px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
        .session-detail.next-session { background: var(--green-light); border-left: 4px solid var(--green); }
        .session-detail .countdown { font-size: 0.95rem; color: var(--green); font-weight: 600; margin-bottom: 0.75rem; }
        .session-title-row { display: flex; justify-content: space-between; align-items: center; gap: 1rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
        .session-title-row h1 { color: var(--dark); font-size: 2rem; margin: 0; line-height: 1.3; }
        .session-title-buttons { display: flex; gap: 0.5rem; align-items: center; }
        .session-detail .date { color: var(--text-mid); font-size: 1.1rem; font-weight: 600; margin-bottom: 0.3rem; }
        .session-detail .group-name { color: var(--text-light); font-size: 1rem; margin-bottom: 1rem; }
        .session-detail .description { color: var(--text-mid); font-size: 1.1rem; line-height: 1.7; margin-bottom: 1.5rem; white-space: pre-wrap; }
        .modal-field textarea { min-height: 120px; }
        .modal-btn-delete { background: var(--error); color: white; }
        .modal-btn-delete:hover { opacity: 0.85; }

        .entries-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .entries-heading { color: var(--dark); font-size: 1.3rem; }
        .header-buttons { display: flex; gap: 0.5rem; align-items: center; }

        .entry-row { display: flex; align-items: center; gap: 0.75rem; }
        a.entry-card { flex: 1; min-width: 0; }

        .checkin-toggle { display: flex; align-items: center; justify-content: center; flex-shrink: 0; cursor: pointer; width: 44px; height: 44px; }
        .checkin-toggle input { position: absolute; opacity: 0; pointer-events: none; }
        .checkin-box {
            width: 28px; height: 28px; border: 2px solid var(--border-mid); border-radius: 6px;
            transition: all 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .checkin-box::after {
            content: ''; display: block; width: 8px; height: 14px;
            border: solid white; border-width: 0 2.5px 2.5px 0; transform: rotate(45deg);
            margin-top: -2px; opacity: 0; transition: opacity 0.2s;
        }
        .checkin-toggle input:checked + .checkin-box { background: var(--green); border-color: var(--green); }
        .checkin-toggle input:checked + .checkin-box::after { opacity: 1; }

        @keyframes spin { to { transform: rotate(360deg); } }
        .spinning svg { animation: spin 0.7s linear infinite; }

        .entry-name-row { display: flex; align-items: center; flex-wrap: wrap; gap: 0.25rem 0.5rem; }
        .entry-name { font-size: 1.05rem; color: var(--dark); }
        .entry-count, .entry-hours { white-space: nowrap; }
        .entry-count strong, .entry-hours strong { color: var(--text-mid); }

        .photo-status { font-size: 0.9rem; color: var(--text-mid); padding: 0.25rem 0; margin-bottom: 0.75rem; }
        .photo-status.error { color: var(--error); }

        @media (max-width: 600px) {
            .session-detail { padding: 1.5rem; }
            .session-title-row h1 { font-size: 1.5rem; }
            .entries-header { flex-wrap: wrap; }
        }
    </style>
    <script src="/js/common.js"></script>
    <script src="/js/session-cards.js"></script>
    <script src="/js/tag-icons.js"></script>
</head>
<body class="detail-page">
    <script>createHeader('Session Details', true);</script>

    <div class="container">
        <div id="content">
            <div class="loading">Loading session details</div>
        </div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal modal-wide">
            <h3>Edit Session</h3>
            <div class="modal-field admin-only">
                <label for="editGroup">Group</label>
                <select id="editGroup" style="width:100%; padding:0.5rem; font-size:0.95rem; border:2px solid var(--border-mid); border-radius:var(--radius); font-family:var(--font);"></select>
            </div>
            <div class="modal-field admin-only">
                <label for="editDate">Date</label>
                <input type="date" id="editDate">
            </div>
            <div class="modal-field">
                <label for="editName">Display Name</label>
                <input type="text" id="editName">
            </div>
            <div class="modal-field">
                <label for="editDescription">Description</label>
                <textarea id="editDescription"></textarea>
            </div>
            <div class="modal-field admin-only">
                <label for="editEventbriteId">Eventbrite Event ID</label>
                <input type="text" id="editEventbriteId">
            </div>
            <div class="modal-buttons" style="justify-content: space-between;">
                <button class="modal-btn modal-btn-delete admin-only" onclick="deleteSession()">Delete</button>
                <div style="display:flex; gap:0.5rem;">
                    <button class="modal-btn modal-btn-cancel" onclick="closeEditModal()">Cancel</button>
                    <button class="modal-btn modal-btn-confirm" id="confirmEditBtn" onclick="saveSessionEdit()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="hoursModal">
        <div class="modal">
            <h3>Set Default Hours</h3>
            <p>Applies to checked-in entries where hours are currently 0.</p>
            <input type="number" id="defaultHoursInput" min="0" step="0.5" value="3">
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-cancel" onclick="closeHoursModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" id="confirmHoursBtn" onclick="applyDefaultHours()">Apply</button>
            </div>
        </div>
    </div>

    <script>
        // Extract group and date from URL: /sessions/:group/:date/details.html
        const pathParts = window.location.pathname.split('/');
        const groupKey = pathParts[2];
        const sessionDate = pathParts[3];

        let sessionEntries = [];
        let currentSession = null;
        let allGroups = [];

        async function loadEditGroups() {
            if (allGroups.length > 0) return;
            try {
                const res = await apiFetch('/api/groups');
                const result = await res.json();
                if (result.success) {
                    allGroups = result.data.sort((a, b) => (a.displayName || a.key).localeCompare(b.displayName || b.key));
                    const select = document.getElementById('editGroup');
                    select.innerHTML = allGroups.map(g =>
                        `<option value="${g.id}" data-key="${escapeHtml(g.key)}">${escapeHtml(g.displayName || g.key)}</option>`
                    ).join('');
                }
            } catch (e) { console.error('Error loading groups:', e); }
        }

        async function openEditModal() {
            if (!currentSession) return;
            await loadEditGroups();
            const select = document.getElementById('editGroup');
            if (currentSession.groupId) select.value = String(currentSession.groupId);
            document.getElementById('editDate').value = currentSession.date ? currentSession.date.substring(0, 10) : '';
            document.getElementById('editName').value = currentSession.displayName || '';
            document.getElementById('editDescription').value = currentSession.description || '';
            document.getElementById('editEventbriteId').value = currentSession.eventbriteEventId || '';
            document.getElementById('editModal').classList.add('visible');
            document.getElementById('editName').focus();
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('visible');
        }

        async function saveSessionEdit() {
            const date = document.getElementById('editDate').value;
            const displayName = document.getElementById('editName').value.trim();
            const description = document.getElementById('editDescription').value;
            const eventbriteEventId = document.getElementById('editEventbriteId').value.trim();
            const groupSelect = document.getElementById('editGroup');
            const selectedGroupId = parseInt(groupSelect.value, 10);
            const selectedOption = groupSelect.options[groupSelect.selectedIndex];
            const selectedGroupKey = selectedOption ? selectedOption.dataset.key : groupKey;
            const groupChanged = currentSession.groupId && selectedGroupId !== currentSession.groupId;

            if (groupChanged) {
                const groupName = selectedOption ? selectedOption.textContent : selectedGroupKey;
                if (!confirm(`Move this session to "${groupName}"? All existing entries will remain attached.`)) return;
            }

            const btn = document.getElementById('confirmEditBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                const body = { displayName, description, eventbriteEventId, date: date || undefined };
                if (groupChanged) body.groupId = selectedGroupId;

                const res = await apiFetch(`/api/sessions/${encodeURIComponent(groupKey)}/${encodeURIComponent(sessionDate)}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Save failed');
                }
                const result = await res.json();
                closeEditModal();
                const newGroupKey = result.data.groupKey || groupKey;
                const newDate = result.data.date || sessionDate;
                if (newGroupKey !== groupKey || newDate !== sessionDate) {
                    window.location.href = `/sessions/${encodeURIComponent(newGroupKey)}/${newDate}/details.html`;
                } else {
                    loadSessionDetail();
                }
            } catch (error) {
                console.error('Error saving session:', error);
                alert(error.message || 'Failed to save session.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Save';
            }
        }

        async function deleteSession() {
            if (!currentSession) return;
            if (!confirm('Delete this session? This cannot be undone.')) return;

            try {
                const res = await apiFetch(`/api/sessions/${encodeURIComponent(groupKey)}/${encodeURIComponent(sessionDate)}`, { method: 'DELETE' });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Delete failed');
                }
                window.location.href = `/groups/${encodeURIComponent(groupKey)}/detail.html`;
            } catch (error) {
                console.error('Error deleting session:', error);
                alert(error.message || 'Failed to delete session.');
            }
        }

        function openHoursModal() {
            document.getElementById('defaultHoursInput').value = '3';
            document.getElementById('hoursModal').classList.add('visible');
            document.getElementById('defaultHoursInput').focus();
        }

        function closeHoursModal() {
            document.getElementById('hoursModal').classList.remove('visible');
        }

        async function applyDefaultHours() {
            const input = document.getElementById('defaultHoursInput');
            const hours = parseFloat(input.value);
            if (isNaN(hours) || hours <= 0) return;

            const btn = document.getElementById('confirmHoursBtn');
            btn.disabled = true;
            btn.textContent = 'Applying...';

            const toUpdate = sessionEntries.filter(e => e.checkedIn && !e.hours);
            try {
                await Promise.all(toUpdate.map(entry =>
                    apiFetch(`/api/entries/${entry.id}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ hours })
                    })
                ));
                closeHoursModal();
                loadSessionDetail();
            } catch (error) {
                console.error('Error setting hours:', error);
                alert('Failed to set hours for some entries.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Apply';
            }
        }

        async function toggleCheckin(entryId, checkbox) {
            const row = checkbox.closest('.entry-row');
            const card = row.querySelector('.entry-card');
            try {
                const res = await apiFetch(`/api/entries/${entryId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ checkedIn: checkbox.checked })
                });
                if (!res.ok) throw new Error();
                card.classList.toggle('checked-in', checkbox.checked);
            } catch {
                checkbox.checked = !checkbox.checked;
            }
        }

        async function refreshSession() {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            btn.classList.add('spinning');
            try {
                const res = await apiFetch(`/api/sessions/${encodeURIComponent(groupKey)}/${encodeURIComponent(sessionDate)}/refresh`, {
                    method: 'POST'
                });
                if (!res.ok) {
                    const data = await res.json();
                    throw new Error(data.error || 'Refresh failed');
                }
                const result = await res.json();
                const d = result.data;
                const parts = [];
                if (d.addedRegulars) parts.push(`${d.addedRegulars} regulars`);
                if (d.addedFromEventbrite) parts.push(`${d.addedFromEventbrite} from Eventbrite`);
                if (d.newProfiles) parts.push(`${d.newProfiles} new profiles`);
                if (d.noPhotoTagged) parts.push(`${d.noPhotoTagged} #NoPhoto`);
                loadSessionDetail();
                if (parts.length > 0) {
                    alert('Added: ' + parts.join(', '));
                }
            } catch (error) {
                console.error('Error refreshing session:', error);
                alert(error.message || 'Failed to refresh session.');
            } finally {
                btn.disabled = false;
            }
        }

        async function loadPhotos() {
            const carousel = document.getElementById('photoCarousel');
            if (!carousel) return;
            try {
                const res = await apiFetch(`/api/photos?groupKey=${encodeURIComponent(groupKey)}&date=${encodeURIComponent(sessionDate)}`);
                const data = await res.json();
                if (!data.success || !data.data.length) { carousel.innerHTML = ''; return; }
                carousel.innerHTML = '<div class="photo-strip">' +
                    data.data.map(p =>
                        `<a href="${escapeHtml(p.webUrl)}" target="_blank" rel="noopener">` +
                        `<img src="${escapeHtml(p.thumbnailUrl)}" alt="${escapeHtml(p.name)}" loading="lazy"></a>`
                    ).join('') + '</div>';
            } catch { carousel.innerHTML = ''; }
        }

        async function uploadPhotos(input) {
            const files = Array.from(input.files);
            if (!files.length) return;
            const carousel = document.getElementById('photoCarousel');

            const setStatus = (msg, isError = false) => {
                if (!carousel) return;
                carousel.innerHTML = `<div class="photo-status${isError ? ' error' : ''}">${escapeHtml(msg)}</div>`;
            };

            const succeeded = [];
            const failed = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                setStatus(`Uploading ${i + 1} of ${files.length}: ${file.name}`);
                const form = new FormData();
                form.append('photo', file);
                form.append('takenAt', file.lastModified.toString());
                form.append('groupKey', groupKey);
                form.append('date', sessionDate);
                try {
                    const res = await fetch('/api/photos/upload', { method: 'POST', body: form });
                    const data = await res.json();
                    if (!res.ok || !data.success) throw new Error(data.error || 'Upload failed');
                    succeeded.push(file.name);
                } catch (e) {
                    failed.push(`${file.name}: ${e.message}`);
                }
            }

            input.value = '';
            if (failed.length) {
                const parts = [];
                if (succeeded.length) parts.push(`${succeeded.length} uploaded`);
                parts.push(`${failed.length} failed`);
                setStatus(parts.join(', '), true);
            }
            loadPhotos();
        }

        async function loadSessionDetail() {
            const contentDiv = document.getElementById('content');

            if (!groupKey || !sessionDate) {
                contentDiv.innerHTML = `
                    <div class="empty-state">
                        <p>No session specified</p>
                        <a href="/sessions.html" class="btn-primary">Back to Sessions</a>
                    </div>
                `;
                return;
            }

            try {
                const response = await apiFetch(`/api/sessions/${encodeURIComponent(groupKey)}/${encodeURIComponent(sessionDate)}`);

                if (!response.ok) {
                    throw new Error(`API returned ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch session');
                }

                const session = result.data;
                currentSession = session;
                document.title = `${session.displayName || formatDate(session.date)} - DTV Tracker`;

                const isPast = new Date(session.date) < new Date(new Date().toDateString());
                const countdown = getCountdown(session.date);

                const statsSection = `
                    <div class="stats-section">
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-number">${session.registrations}</div>
                                <div class="stat-label">${isPast ? 'Attendees' : 'Registrations'}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${session.hours}</div>
                                <div class="stat-label">Hours</div>
                            </div>
                        </div>
                    </div>
                `;

                const entries = session.entries || [];
                sessionEntries = entries;
                const entriesHtml = entries.length > 0
                    ? entries.map(entry => {
                        const icons = notesToIcons(entry.notes);
                        const groupBadge = entry.isGroup ? '<img src="/svg/group.svg" class="group-badge" alt="Group" title="Group">' : '';
                        const memberBadge = entry.isMember && !entry.isGroup ? '<img src="/svg/member.svg" class="member-badge" alt="Member" title="Member">' : '';
                        const cardBadge = entry.cardStatus ? `<img src="/svg/card.svg" class="card-badge${entry.cardStatus === 'Invited' ? ' invited' : ''}" alt="Card" title="Card">` : '';
                        const href = entry.volunteerSlug
                            ? `/entries/${encodeURIComponent(groupKey)}/${sessionDate}/${encodeURIComponent(entry.volunteerSlug)}/edit.html`
                            : '#';
                        const metaItems = [
                            entry.count > 1 ? `<span class="entry-count"><strong>Count:</strong> ${entry.count}</span>` : '',
                            entry.hours ? `<span class="entry-hours"><strong>Hours:</strong> ${entry.hours}</span>` : ''
                        ].filter(Boolean).join('');
                        return `
                            <div class="entry-row">
                                <label class="checkin-toggle">
                                    <input type="checkbox" ${entry.checkedIn ? 'checked' : ''}
                                           onchange="toggleCheckin(${entry.id}, this)">
                                    <span class="checkin-box"></span>
                                </label>
                                <a class="entry-card${entry.checkedIn ? ' checked-in' : ''}" href="${href}">
                                    <div class="entry-name-row" style="flex:1">
                                        <div class="entry-name">
                                            ${escapeHtml(entry.volunteerName || 'Unknown')}${groupBadge}${memberBadge}${cardBadge}
                                        </div>
                                        ${icons ? `<div class="entry-tags">${icons}</div>` : ''}
                                    </div>
                                    ${metaItems ? `<div class="entry-meta">${metaItems}</div>` : ''}
                                </a>
                            </div>
                        `;
                    }).join('')
                    : '<p class="no-sessions">No registrations yet</p>';

                contentDiv.innerHTML = `
                    <div class="session-detail${countdown ? ' next-session' : ''}">
                        ${countdown ? `<div class="countdown">Next session &middot; ${countdown}</div>` : ''}
                        <div class="date">${formatDate(session.date)}</div>
                        <div class="session-title-row">
                            <h1>${escapeHtml(session.displayName || 'Session')}</h1>
                            <div class="session-title-buttons">
                                <label class="btn-action checkin-only" style="cursor:pointer;" title="Upload photos">
                                    <svg viewBox="0 0 24 24" fill="none">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M8 10C8 7.79086 9.79086 6 12 6C14.2091 6 16 7.79086 16 10V11H17C18.933 11 20.5 12.567 20.5 14.5C20.5 16.433 18.933 18 17 18H16C15.4477 18 15 18.4477 15 19C15 19.5523 15.4477 20 16 20H17C20.0376 20 22.5 17.5376 22.5 14.5C22.5 11.7793 20.5245 9.51997 17.9296 9.07824C17.4862 6.20213 15.0003 4 12 4C8.99974 4 6.51381 6.20213 6.07036 9.07824C3.47551 9.51997 1.5 11.7793 1.5 14.5C1.5 17.5376 3.96243 20 7 20H8C8.55228 20 9 19.5523 9 19C9 18.4477 8.55228 18 8 18H7C5.067 18 3.5 16.433 3.5 14.5C3.5 12.567 5.067 11 7 11H8V10ZM15.7071 13.2929L12.7071 10.2929C12.3166 9.90237 11.6834 9.90237 11.2929 10.2929L8.29289 13.2929C7.90237 13.6834 7.90237 14.3166 8.29289 14.7071C8.68342 15.0976 9.31658 15.0976 9.70711 14.7071L11 13.4142V19C11 19.5523 11.4477 20 12 20C12.5523 20 13 19.5523 13 19V13.4142L14.2929 14.7071C14.6834 15.0976 15.3166 15.0976 15.7071 14.7071C16.0976 14.3166 16.0976 13.6834 15.7071 13.2929Z" fill="currentColor"/>
                                    </svg>
                                    <input type="file" accept="image/*" multiple style="display:none;" onchange="uploadPhotos(this)">
                                </label>
                                <button class="btn-action checkin-only" onclick="openEditModal()" title="Edit session">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                                        <path d="m15 5 4 4"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        ${session.groupName ? `<div class="group-name">${escapeHtml(session.groupName)}</div>` : ''}
                        <div id="photoCarousel"></div>
                        ${session.description ? `<div class="description">${escapeHtml(session.description)}</div>` : ''}
                        ${statsSection}
                    </div>
                    <div class="entries-header">
                        <h2 class="entries-heading">Entries (${entries.length})</h2>
                        <div class="header-buttons">
                            <button class="btn-action checkin-only" id="refreshBtn" onclick="refreshSession()" title="Refresh session">
                                <svg viewBox="0 0 16 16" fill="none"><path d="M2 8a6 6 0 0 1 10.3-4.2L11 5h4V1l-1.7 1.7A8 8 0 0 0 0 8h2zm12 0a6 6 0 0 1-10.3 4.2L5 11H1v4l1.7-1.7A8 8 0 0 0 16 8h-2z" fill="currentColor"/></svg>
                            </button>
                            <button class="btn-action checkin-only" onclick="openHoursModal()">Set Hours</button>
                            <a class="btn-action checkin-only" href="/sessions/${encodeURIComponent(groupKey)}/${sessionDate}/add-entry.html">
                                <svg viewBox="0 0 16 16"><path d="M8 2v12M2 8h12" stroke="white" stroke-width="2" stroke-linecap="round" fill="none"/></svg>
                            </a>
                        </div>
                    </div>
                    <div class="entries-list">
                        ${entriesHtml}
                    </div>
                `;
                initEventbriteButtons(contentDiv);
                clampDescriptions(contentDiv);
                loadPhotos();

            } catch (error) {
                console.error('Error loading session detail:', error);
                showError(contentDiv, 'Error Loading Session', error.message);
            }
        }

        loadSessionDetail();
    </script>
</body>
</html>
