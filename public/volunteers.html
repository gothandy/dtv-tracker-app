<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volunteers - DTV Tracker</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        body { min-height: 100vh; display: flex; flex-direction: column; }
        .container { max-width: 900px; padding: 1.5rem; flex: 1; }

        .volunteer-list { display: flex; flex-direction: column; gap: 0.75rem; }
        a.volunteer-card { text-decoration: none; color: inherit; }
        .volunteer-card {
            background: var(--surface); border-radius: var(--radius); padding: 1rem 1.25rem;
            box-shadow: var(--shadow); display: flex; align-items: center; gap: 1rem;
            transition: transform 0.2s, box-shadow 0.2s; cursor: pointer;
        }
        .volunteer-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); }
        .volunteer-card.is-member { background: var(--green-light); border-left: 4px solid var(--green); }

        .volunteer-name { flex: 1; font-family: var(--font-heading); font-weight: normal; font-size: 1.05rem; color: var(--dark); }
        .volunteer-name .group-badge, .volunteer-name .member-badge, .volunteer-name .card-badge {
            display: inline-block; width: 16px; height: 16px;
            vertical-align: middle; margin-left: 0.4rem;
            filter: invert(49%) sepia(90%) saturate(400%) hue-rotate(103deg) brightness(92%) contrast(90%);
        }
        .volunteer-name .card-badge.invited {
            filter: invert(55%) sepia(80%) saturate(600%) hue-rotate(10deg) brightness(95%) contrast(90%);
        }

        .volunteer-meta { display: flex; gap: 1rem; align-items: center; font-size: 0.9rem; color: var(--text-lighter); flex-shrink: 0; }
        .volunteer-meta span { white-space: nowrap; }
        .volunteer-meta strong { color: var(--text-mid); }

        .advanced-toggle {
            padding: 0.5rem 0.75rem; border: 2px solid var(--border-mid);
            border-radius: var(--radius); background: var(--surface);
            cursor: pointer; font-size: 0.9rem; color: var(--text-mid);
            display: flex; align-items: center; gap: 0.3rem;
            min-height: 38px; white-space: nowrap; font-family: var(--font);
        }
        .advanced-toggle:hover { border-color: var(--green); }
        .advanced-toggle.active { border-color: var(--green); color: var(--green); }

        .advanced-section {
            max-height: 0; overflow: hidden; opacity: 0;
            transition: max-height 0.3s ease, opacity 0.2s ease, margin 0.3s ease;
        }
        .advanced-section.open { max-height: 200px; opacity: 1; margin-top: 0.75rem; }
        .advanced-row { display: flex; gap: 0.5rem; align-items: center; }
        .advanced-row + .advanced-row { margin-top: 0.5rem; }
        .advanced-row select {
            flex: 1; padding: 0.5rem 0.75rem; font-size: 0.9rem;
            border: 2px solid var(--border-mid); border-radius: var(--radius);
            font-family: var(--font); background: var(--surface); color: var(--text);
            min-height: 38px; min-width: 0;
        }
        .advanced-row select:focus { outline: none; border-color: var(--green); }

        @media (max-width: 600px) {
            .filter-search { width: 100%; }
            .advanced-section.open { max-height: 600px; }
            .advanced-row { flex-direction: column; }
            .advanced-row select { width: 100%; }
            .volunteer-card { flex-direction: column; align-items: flex-start; gap: 0.5rem; }
            .volunteer-meta { width: 100%; justify-content: flex-start; }
        }
    </style>
    <script src="/js/common.js"></script>
</head>
<body>
    <script>createHeader('Volunteers', true);</script>

    <div class="container">
        <div class="filter-bar">
            <div class="title-row">
                <div class="title-left">
                    <h2>Volunteers</h2>
                    <div class="count" id="volunteerCount">-</div>
                </div>
                <div style="display:flex; gap:0.5rem;">
                    <div class="dropdown">
                        <button class="dropdown-btn" onclick="toggleDropdown('filterMenu')">
                            <svg viewBox="0 0 16 16"><path d="M1.5 1.5h13L10 7.5V13l-4 2V7.5z"/></svg>
                            <span id="filterLabel">This FY</span>
                        </button>
                        <div class="dropdown-menu" id="filterMenu">
                            <button id="btnAll" onclick="setFilter('all')">All</button>
                            <button id="btnLastFY" onclick="setFilter('lastFy')">Last FY</button>
                            <button id="btnThisFY" class="active" onclick="setFilter('thisFy')">This FY</button>
                        </div>
                    </div>
                    <div class="dropdown">
                        <button class="dropdown-btn" onclick="toggleDropdown('sortMenu')">
                            <svg viewBox="0 0 16 16"><path d="M2 4h12M4 8h8M6 12h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" fill="none"/></svg>
                            <span id="sortLabel">A-Z</span>
                        </button>
                        <div class="dropdown-menu" id="sortMenu">
                            <button id="btnSortAZ" class="active" onclick="setSort('az')">A-Z</button>
                            <button id="btnSortHours" onclick="setSort('hours')">Hours</button>
                        </div>
                    </div>
                    <a class="btn-action" href="/volunteers/add.html">
                        <svg viewBox="0 0 16 16"><path d="M8 2v12M2 8h12" stroke="white" stroke-width="2" stroke-linecap="round" fill="none"/></svg>
                    </a>
                </div>
            </div>
            <div class="filter-row">
                <input type="text" class="filter-search" id="searchBox" placeholder="Search..." autocomplete="off">
                <button class="advanced-toggle" id="advancedToggle" onclick="toggleAdvanced()">Advanced &#9662;</button>
            </div>
            <div class="advanced-section" id="advancedSection">
                <div class="advanced-row">
                    <select id="groupSelect" onchange="setGroup(this.value)">
                        <option value="">All Groups</option>
                    </select>
                    <select id="typeSelect" onchange="setTypeFilter(this.value)">
                        <option value="">All Profiles</option>
                        <option value="individuals">Individuals</option>
                        <option value="groups">Groups</option>
                    </select>
                    <select id="hoursSelect" onchange="setHoursFilter(this.value)">
                        <option value="">All Hours</option>
                        <option value="0">0h</option>
                        <option value="lt15">&lt;15h</option>
                        <option value="15plus">15h+</option>
                        <option value="15to30">15-30h</option>
                        <option value="30plus">30h+</option>
                    </select>
                </div>
                <div class="advanced-row">
                    <select id="recordTypeSelect" onchange="setRecordType(this.value)">
                        <option value="">All Record Types</option>
                    </select>
                    <select id="recordStatusSelect" onchange="setRecordStatus(this.value)">
                        <option value="">All Statuses</option>
                        <option value="none">No Record</option>
                    </select>
                </div>
                <div class="advanced-row" style="justify-content: flex-end;">
                    <button class="advanced-toggle admin-only" onclick="openBulkRecords()">Add Records</button>
                    <button class="advanced-toggle admin-only" onclick="downloadCSV()">Download CSV</button>
                </div>
            </div>
        </div>

        <div class="modal-overlay" id="bulkRecordModal">
            <div class="modal">
                <h3>Add Records</h3>
                <p id="bulkRecordCount"></p>
                <div style="display:flex; flex-direction:column; gap:0.75rem; margin: 1rem 0;">
                    <select id="bulkRecordType" style="padding:0.5rem; font-size:0.95rem; border:2px solid var(--border-mid); border-radius:var(--radius); font-family:var(--font);">
                        <option value="">Select type...</option>
                    </select>
                    <select id="bulkRecordStatus" style="padding:0.5rem; font-size:0.95rem; border:2px solid var(--border-mid); border-radius:var(--radius); font-family:var(--font);">
                        <option value="">Select status...</option>
                    </select>
                    <input type="date" id="bulkRecordDate" style="padding:0.5rem; font-size:0.95rem; border:2px solid var(--border-mid); border-radius:var(--radius); font-family:var(--font);">
                </div>
                <p id="bulkRecordSummary" style="font-weight:600; color:var(--text-mid); min-height:1.2rem;"></p>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-cancel" onclick="closeBulkRecords()">Cancel</button>
                    <button class="modal-btn modal-btn-confirm" id="bulkRecordConfirm" onclick="submitBulkRecords()">Confirm</button>
                </div>
            </div>
        </div>

        <div id="content">
            <div class="loading">Loading volunteers</div>
        </div>
    </div>

    <script>
        let allVolunteers = [];
        let currentFilter = 'thisFy';
        let currentSort = 'az';
        let currentGroup = '';
        let currentTypeFilter = '';
        let currentHoursFilter = '';
        let currentRecordType = '';
        let currentRecordStatus = '';
        const MEMBER_HOURS = 15;

        function toggleAdvanced() {
            const section = document.getElementById('advancedSection');
            const btn = document.getElementById('advancedToggle');
            const isOpen = section.classList.toggle('open');
            btn.classList.toggle('active', isOpen);
            btn.innerHTML = isOpen ? 'Advanced &#9652;' : 'Advanced &#9662;';
            if (!isOpen) {
                currentTypeFilter = '';
                currentHoursFilter = '';
                currentRecordType = '';
                currentRecordStatus = '';
                document.getElementById('typeSelect').value = '';
                document.getElementById('hoursSelect').value = '';
                document.getElementById('recordTypeSelect').value = '';
                document.getElementById('recordStatusSelect').value = '';
                if (currentGroup) {
                    currentGroup = '';
                    document.getElementById('groupSelect').value = '';
                    loadVolunteers();
                } else {
                    displayVolunteers();
                }
            }
        }

        function setFilter(filter) {
            currentFilter = filter;
            const labels = { all: 'All', lastFy: 'Last FY', thisFy: 'This FY' };
            document.getElementById('filterLabel').textContent = labels[filter];
            ['btnAll', 'btnLastFY', 'btnThisFY'].forEach(id => document.getElementById(id).classList.remove('active'));
            const btnMap = { all: 'btnAll', lastFy: 'btnLastFY', thisFy: 'btnThisFY' };
            document.getElementById(btnMap[filter]).classList.add('active');
            document.querySelectorAll('.dropdown-menu.open').forEach(m => m.classList.remove('open'));
            displayVolunteers();
        }

        function setSort(sort) {
            currentSort = sort;
            const labels = { az: 'A-Z', hours: 'Hours' };
            document.getElementById('sortLabel').textContent = labels[sort];
            ['btnSortAZ', 'btnSortHours'].forEach(id => document.getElementById(id).classList.remove('active'));
            const btnMap = { az: 'btnSortAZ', hours: 'btnSortHours' };
            document.getElementById(btnMap[sort]).classList.add('active');
            document.querySelectorAll('.dropdown-menu.open').forEach(m => m.classList.remove('open'));
            displayVolunteers();
        }

        function setGroup(groupKey) {
            currentGroup = groupKey;
            loadVolunteers();
        }

        function isMember(v) {
            return !!v.isMember;
        }

        function isMemberForFY(v, fyFilter) {
            if (fyFilter === 'thisFy') return v.hoursThisFY >= MEMBER_HOURS;
            if (fyFilter === 'lastFy') return v.hoursLastFY >= MEMBER_HOURS;
            return isMember(v);
        }

        function getHours(v) {
            if (currentFilter === 'thisFy') return v.hoursThisFY;
            if (currentFilter === 'lastFy') return v.hoursLastFY;
            return v.hoursThisFY + v.hoursLastFY;
        }

        function getSessions(v) {
            if (currentFilter === 'thisFy') return v.sessionsThisFY;
            if (currentFilter === 'lastFy') return v.sessionsLastFY;
            return v.sessionsThisFY + v.sessionsLastFY;
        }

        function displayVolunteers() {
            const contentDiv = document.getElementById('content');
            const countDiv = document.getElementById('volunteerCount');
            const searchTerm = document.getElementById('searchBox').value;

            let filtered = allVolunteers;
            if (currentTypeFilter === 'individuals') {
                filtered = filtered.filter(v => !v.isGroup);
            } else if (currentTypeFilter === 'groups') {
                filtered = filtered.filter(v => v.isGroup);
            }
            if (currentFilter === 'thisFy') {
                filtered = filtered.filter(v => v.hoursThisFY > 0);
            } else if (currentFilter === 'lastFy') {
                filtered = filtered.filter(v => v.hoursLastFY > 0);
            }
            if (searchTerm && searchTerm.length >= 3) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(v => (v.name || '').toLowerCase().includes(term));
            }
            if (currentHoursFilter) {
                const hFilters = {
                    '0': v => getHours(v) === 0,
                    'lt15': v => { const h = getHours(v); return h > 0 && h < 15; },
                    '15plus': v => getHours(v) >= 15,
                    '15to30': v => { const h = getHours(v); return h >= 15 && h <= 30; },
                    '30plus': v => getHours(v) > 30
                };
                if (hFilters[currentHoursFilter]) filtered = filtered.filter(hFilters[currentHoursFilter]);
            }
            if (currentRecordType) {
                filtered = filtered.filter(v => {
                    const recs = (v.records || []).filter(r => r.type === currentRecordType);
                    if (currentRecordStatus === 'none') return recs.length === 0;
                    if (currentRecordStatus) return recs.some(r => r.status === currentRecordStatus);
                    return recs.length > 0;
                });
            } else if (currentRecordStatus === 'none') {
                filtered = filtered.filter(v => !v.records || v.records.length === 0);
            }

            // Sort
            if (currentSort === 'hours') {
                filtered = [...filtered].sort((a, b) => getHours(b) - getHours(a) || (a.name || '').localeCompare(b.name || ''));
            } else {
                filtered = [...filtered].sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            }

            countDiv.textContent = filtered.length;

            if (filtered.length === 0) {
                contentDiv.innerHTML = '<p class="no-sessions">No volunteers found</p>';
                return;
            }

            const html = filtered.map(v => {
                const member = isMember(v);
                const memberForFY = isMemberForFY(v, currentFilter);
                const groupBadge = v.isGroup ? '<img src="/svg/group.svg" class="group-badge" alt="Group" title="Group">' : '';
                const memberBadge = member && !v.isGroup ? '<img src="/svg/member.svg" class="member-badge" alt="Member" title="Member">' : '';
                const cardBadge = v.cardStatus ? `<img src="/svg/card.svg" class="card-badge${v.cardStatus === 'Invited' ? ' invited' : ''}" alt="Card" title="Card">` : '';
                const cardClass = memberForFY && !v.isGroup ? ' is-member' : '';
                const href = v.slug ? `/profiles/${encodeURIComponent(v.slug)}/details.html` : '#';
                const sessions = getSessions(v);
                const hours = getHours(v);
                return `
                    <a class="volunteer-card${cardClass}" href="${href}">
                        <div class="volunteer-name">${escapeHtml(v.name || 'Unknown')}${groupBadge}${memberBadge}${cardBadge}</div>
                        <div class="volunteer-meta">
                            <span><strong>Sessions:</strong> ${sessions}</span>
                            <span><strong>Hours:</strong> ${hours}</span>
                        </div>
                    </a>
                `;
            }).join('');

            contentDiv.innerHTML = `<div class="volunteer-list">${html}</div>`;
        }

        async function loadVolunteers() {
            const contentDiv = document.getElementById('content');

            try {
                const url = currentGroup
                    ? `/api/profiles?group=${encodeURIComponent(currentGroup)}`
                    : '/api/profiles';
                const response = await apiFetch(url);
                if (!response.ok) {
                    throw new Error(`API returned ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch volunteers');
                }

                allVolunteers = result.data;
                displayVolunteers();

            } catch (error) {
                console.error('Error loading volunteers:', error);
                showError(contentDiv, 'Error Loading Volunteers', error.message);
            }
        }

        async function loadGroups() {
            try {
                const response = await apiFetch('/api/groups');
                if (!response.ok) return;
                const result = await response.json();
                if (!result.success) return;

                const select = document.getElementById('groupSelect');
                result.data
                    .sort((a, b) => (a.displayName || a.key).localeCompare(b.displayName || b.key))
                    .forEach(g => {
                        const opt = document.createElement('option');
                        opt.value = g.key;
                        opt.textContent = g.displayName || g.key;
                        select.appendChild(opt);
                    });
            } catch (e) {
                console.error('Error loading groups:', e);
            }
        }

        function setTypeFilter(val) { currentTypeFilter = val; displayVolunteers(); }
        function setHoursFilter(val) { currentHoursFilter = val; displayVolunteers(); }
        function setRecordType(val) { currentRecordType = val; displayVolunteers(); }
        function setRecordStatus(val) { currentRecordStatus = val; displayVolunteers(); }

        function downloadCSV() {
            const params = new URLSearchParams();
            params.set('fy', currentFilter);
            if (currentGroup) params.set('group', currentGroup);
            const searchTerm = document.getElementById('searchBox').value.trim();
            if (searchTerm) params.set('search', searchTerm);
            if (currentTypeFilter) params.set('type', currentTypeFilter);
            if (currentHoursFilter) params.set('hours', currentHoursFilter);
            if (currentRecordType) params.set('recordType', currentRecordType);
            if (currentRecordStatus) params.set('recordStatus', currentRecordStatus);
            window.location.href = '/api/profiles/export?' + params.toString();
        }

        async function loadRecordOptions() {
            try {
                const res = await apiFetch('/api/records/options');
                if (!res.ok) return;
                const result = await res.json();
                if (!result.success) return;
                const typeSelect = document.getElementById('recordTypeSelect');
                result.data.types.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t;
                    opt.textContent = t;
                    typeSelect.appendChild(opt);
                });
                const statusSelect = document.getElementById('recordStatusSelect');
                result.data.statuses.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.textContent = s;
                    statusSelect.appendChild(opt);
                });
            } catch (e) {
                console.error('Error loading record options:', e);
            }
        }

        function getFilteredIndividuals() {
            let filtered = allVolunteers.filter(v => !v.isGroup);
            if (currentTypeFilter === 'groups') return [];
            if (currentFilter === 'thisFy') filtered = filtered.filter(v => v.hoursThisFY > 0);
            else if (currentFilter === 'lastFy') filtered = filtered.filter(v => v.hoursLastFY > 0);
            const searchTerm = document.getElementById('searchBox').value;
            if (searchTerm && searchTerm.length >= 3) {
                const term = searchTerm.toLowerCase();
                filtered = filtered.filter(v => (v.name || '').toLowerCase().includes(term));
            }
            if (currentHoursFilter) {
                const hFilters = {
                    '0': v => getHours(v) === 0,
                    'lt15': v => { const h = getHours(v); return h > 0 && h < 15; },
                    '15plus': v => getHours(v) >= 15,
                    '15to30': v => { const h = getHours(v); return h >= 15 && h <= 30; },
                    '30plus': v => getHours(v) > 30
                };
                if (hFilters[currentHoursFilter]) filtered = filtered.filter(hFilters[currentHoursFilter]);
            }
            if (currentRecordType) {
                filtered = filtered.filter(v => {
                    const recs = (v.records || []).filter(r => r.type === currentRecordType);
                    if (currentRecordStatus === 'none') return recs.length === 0;
                    if (currentRecordStatus) return recs.some(r => r.status === currentRecordStatus);
                    return recs.length > 0;
                });
            } else if (currentRecordStatus === 'none') {
                filtered = filtered.filter(v => !v.records || v.records.length === 0);
            }
            return filtered;
        }

        let bulkRecordOptions = null;

        async function openBulkRecords() {
            const individuals = getFilteredIndividuals();
            if (individuals.length === 0) {
                alert('No individual volunteers in the current filter.');
                return;
            }
            document.getElementById('bulkRecordCount').textContent =
                `${individuals.length} individual volunteer${individuals.length === 1 ? '' : 's'} in current filter.`;
            document.getElementById('bulkRecordSummary').textContent = '';

            if (!bulkRecordOptions) {
                try {
                    const res = await apiFetch('/api/records/options');
                    const result = await res.json();
                    if (result.success) bulkRecordOptions = result.data;
                } catch (e) { console.error(e); }
            }
            if (bulkRecordOptions) {
                const typeSelect = document.getElementById('bulkRecordType');
                typeSelect.innerHTML = '<option value="">Select type...</option>';
                bulkRecordOptions.types.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t; opt.textContent = t;
                    typeSelect.appendChild(opt);
                });
                const statusSelect = document.getElementById('bulkRecordStatus');
                statusSelect.innerHTML = '<option value="">Select status...</option>';
                bulkRecordOptions.statuses.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s; opt.textContent = s;
                    statusSelect.appendChild(opt);
                });
            }
            document.getElementById('bulkRecordDate').value = new Date().toISOString().substring(0, 10);
            document.getElementById('bulkRecordModal').classList.add('visible');
        }

        function closeBulkRecords() {
            document.getElementById('bulkRecordModal').classList.remove('visible');
        }

        async function submitBulkRecords() {
            const type = document.getElementById('bulkRecordType').value;
            const status = document.getElementById('bulkRecordStatus').value;
            const dateVal = document.getElementById('bulkRecordDate').value;
            if (!type || !status) {
                alert('Please select a record type and status.');
                return;
            }

            const individuals = getFilteredIndividuals();
            const count = individuals.length;
            if (!confirm(`You are about to update ${count} volunteer record${count === 1 ? '' : 's'} with "${type}: ${status}". Continue?`)) return;

            const btn = document.getElementById('bulkRecordConfirm');
            btn.disabled = true;
            btn.textContent = 'Processing...';
            const summary = document.getElementById('bulkRecordSummary');
            summary.textContent = '';

            try {
                const date = dateVal ? new Date(dateVal + 'T10:00:00.000Z').toISOString() : new Date().toISOString();
                const profileIds = individuals.map(v => v.id);
                const res = await apiFetch('/api/records/bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ profileIds, type, status, date })
                });
                const result = await res.json();
                if (!res.ok || !result.success) throw new Error(result.error || 'Bulk update failed');

                const d = result.data;
                summary.textContent = `Done: ${d.created} created, ${d.updated} updated.`;
                setTimeout(() => {
                    closeBulkRecords();
                    loadVolunteers();
                }, 1500);
            } catch (error) {
                summary.textContent = error.message || 'Failed';
                summary.style.color = 'var(--error)';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Confirm';
            }
        }

        document.getElementById('searchBox').addEventListener('input', displayVolunteers);

        loadVolunteers();
        loadGroups();
        loadRecordOptions();
    </script>
</body>
</html>
